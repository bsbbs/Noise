---
title: "Noise Project, Behavioral data analysis"
author: "Bo Shen, NYU"
date: "9/6/2024"
output: html_document
---

## Set the root directory
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/bs3667/Dropbox (NYU Langone Health)/Bo Shen Working files/NoiseProject/AnalysisII')
```

## define directories
```{r}
data_dir <- '/Users/bs3667/Dropbox (NYU Langone Health)/CESS-Bo/TaskProgram/log/txtDat'
out_dir <- '/Users/bs3667/Dropbox (NYU Langone Health)/Bo Shen Working files/NoiseProject/AnalysisII'
```
# load data
```{r}
filelistbid <- list.files(path = data_dir, pattern = 'BidTask_')
filelistchoice <- list.files(path = data_dir, pattern = 'MainTask_')
grpbid <- c()
grpdcsn <- c()
for (s in 1:length(filelistbid))
{
  indvbid <- read.table(file.path(data_dir,filelistbid[s]), head = TRUE, sep = '\t')
  grpbid <- rbind(grpbid,indvbid)
  indvdcsn <- read.table(file.path(data_dir,filelistchoice[s]), head = TRUE, sep = '\t')
  grpdcsn <- rbind(grpdcsn,indvdcsn)
}
# define variable types in bid data
grpbid$touched <- factor(as.numeric(grpbid$Group == grpbid$patch), level = c(1,0))
grpbid$Group <- as.factor(grpbid$Group)
grpbid$subID <- as.factor(grpbid$subID)
grpbid$trial <- as.factor(grpbid$trial)
grpbid$item <- as.factor(grpbid$item)
# define varibale types in choice data
grpdcsn$Group <- as.factor(grpdcsn$Group)
grpdcsn$subID <- as.factor(grpdcsn$subID)
grpdcsn$Vagueness <- as.factor(grpdcsn$Vagueness)
grpdcsn$TimePressure <- as.factor(grpdcsn$TimePressure)
```
## check data, excluding subjects
```{r, echo=FALSE, include=FALSE}
blacklist <- c('22102405', '22102705', '22071913', '22102708', '22110306') # screening 5 out of 60
# from the above screening, 22102405 and 22102705 bid all targets as zero.
# 22071913 bid all V3 as zero, 22102708 bid all v3 and five targets as zero, 22110306 bid one of the targets as zero
grpbid <- grpbid[!grpbid$subID %in% blacklist,]
grpdcsn <- grpdcsn[!grpdcsn$subID %in% blacklist,]
str(grpbid)
str(grpdcsn)
subjlist <- unique(grpbid$subID)
Nsubj <- length(subjlist)
```

# data transformation
```{r}
# Calculate the variability of participants' rating, as a function of the bid mean value
meanbid <- aggregate(bid ~ item +  subID, FUN = mean, data = grpbid)
meanbid$bid <- round(meanbid$bid, 2)
sdbid <- aggregate(bid ~ item + subID, FUN = sd, data = grpbid)
# sdbid$bid <- round(sdbid$bid, 2)
varbid <- aggregate(bid ~ item + subID, FUN = var, data = grpbid)
# varbid$bid <- round(varbid$bid, 2)
# grpdcsn <- grpdcsn[,!names(grpdcsn) %in% c('V1', 'V2', 'V3')]
# tmp <- meanbid
# names(tmp) <- c('ID1','subID','V1')
# grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID1'))
# names(tmp) <- c('ID2','subID','V2')
# grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID2'))
# names(tmp) <- c('ID3','subID','V3')
# grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID3'))

# combine the bidding variance into choice data
tmp <- sdbid
names(tmp) <- c('ID1','subID','sdbid1')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID1'))
tmp <- sdbid
names(tmp) <- c('ID2','subID','sdbid2')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID2'))
tmp <- sdbid
names(tmp) <- c('ID3','subID','sdbid3')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID3'))

tmp <- varbid
names(tmp) <- c('ID1','subID','varbid1')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID1'))
tmp <- varbid
names(tmp) <- c('ID2','subID','varbid2')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID2'))
tmp <- varbid
names(tmp) <- c('ID3','subID','varbid3')
grpdcsn <- merge(grpdcsn, tmp, by = c('subID','ID3'))
grpdcsn <- grpdcsn[order(grpdcsn$subID, grpdcsn$trial), ]

# alignment of choice data across subjects according to the minimum target value
grpdcsn$V1scld <- grpdcsn$V1
grpdcsn$V2scld <- grpdcsn$V1
grpdcsn$V3scld <- grpdcsn$V1
grpdcsn$sdbid1scld <- grpdcsn$V1
grpdcsn$sdbid2scld <- grpdcsn$V1
grpdcsn$sdbid3scld <- grpdcsn$V1
grpdcsn$varbid1scld <- grpdcsn$V1
grpdcsn$varbid2scld <- grpdcsn$V1
grpdcsn$varbid3scld <- grpdcsn$V1
grpdcsn$sdbidlabel <- grpdcsn$Vagueness
subjlist <- unique(grpdcsn$subID)
minvals_new <- c()
for (s in subjlist)
{
  mask <- grpdcsn$subID == s
  minval <- min(c(grpdcsn$V1[mask], grpdcsn$V2[mask]))
  grpdcsn$V1scld[mask] <- grpdcsn$V1[mask]/minval
  grpdcsn$V2scld[mask] <- grpdcsn$V2[mask]/minval
  grpdcsn$V3scld[mask] <- grpdcsn$V3[mask]/minval
  grpdcsn$sdbid1scld[mask] <- grpdcsn$sdbid1[mask]/minval
  grpdcsn$sdbid2scld[mask] <- grpdcsn$sdbid2[mask]/minval
  grpdcsn$sdbid3scld[mask] <- grpdcsn$sdbid3[mask]/minval
  grpdcsn$varbid1scld[mask] <- grpdcsn$varbid1[mask]/minval^2
  grpdcsn$varbid2scld[mask] <- grpdcsn$varbid2[mask]/minval^2
  grpdcsn$varbid3scld[mask] <- grpdcsn$varbid3[mask]/minval^2
}
grpdcsn$sdbidlabel[grpdcsn$sdbid3 > median(grpdcsn$sdbid3)] <- "Vague"
grpdcsn$sdbidlabel[grpdcsn$sdbid3 <= median(grpdcsn$sdbid3)] <- "Precise"
grpdcsn$VD <- grpdcsn$V2 - grpdcsn$V1 # difference between two targets, in the design, V2 is always larger than V1
grpdcsn$choice <- grpdcsn$chosenItem - 1 # choose #1 coded as 0 (incorrect); choose #2 coded as 1 (correct); choose #3 coded as 2, discard; NaN choice not made
grpdcsn$VDscld <- grpdcsn$V2scld - grpdcsn$V1scld
# discard the trials where choice is not made
grpdcsn <- grpdcsn[!is.na(grpdcsn$choice),]
# discard the trials where V1 == V2
grpdcsn <- grpdcsn[grpdcsn$V1 != grpdcsn$V2,]
str(grpdcsn)
```
# Aggregate choice accuracy based on V3scaled, Pooled subjects
```{r}
AccV3scld <- c()
subID <- unique(grpdcsn$subID)
Vagueness <- unique(grpdcsn$Vagueness)
TimePressure <- unique(grpdcsn$TimePressure)
vi <- 0
for (v in Vagueness) # representation noise
{
  vi <- vi + 1
  tpi <- 0
  for (tp in TimePressure) # decision noise
  {
    tpi <- tpi + 1
    sectdat <- grpdcsn[grpdcsn$TimePressure == tp & grpdcsn$Vagueness == v & grpdcsn$chosenItem != 3 & !is.nan(grpdcsn$chosenItem),]
    acc <- aggregate(choice ~ V3scld, data = sectdat, FUN = mean)
    sdbid <- aggregate(sdbid3scld ~ V3scld, data = sectdat, FUN = mean)
    colnames(acc) <- c('V3scld','acc')
    acc$acc <- acc$acc*100
    Ntrial <- aggregate(trial ~ V3scld, data = sectdat, FUN = length)
    colnames(Ntrial) <- c('V3scld','Ntrial')
    onesect <- merge(acc, sdbid, by = 'V3scld')
    onesect <- merge(onesect, Ntrial, by = 'V3scld')
    AccV3scld <- rbind(AccV3scld, data.frame(Vagueness = v, TimePressure = tp, onesect))
  }
}
write.table(AccV3scld, file = file.path('/Users/bs3667/Dropbox (NYU Langone Health)/CESS-Bo/myData', 'AccVarV3scld.txt'), quote = FALSE, sep = "\t", eol = "\n", row.names = FALSE)
```
## Aggregate choice accuracy based on ID3 within each subjects
```{r}
subID <- unique(grpdcsn$subID)
Vagueness <- unique(grpdcsn$Vagueness)
TimePressure <- unique(grpdcsn$TimePressure)
AccID3 <- c()
for (s in 1:length(subID))
{
  indvdat <- grpdcsn[grpdcsn$subID == subID[s],]
  vi <- 0
  for (v in Vagueness)
  {
    vi <- vi + 1
    tpi <- 0
    for (tp in TimePressure)
    {
      tpi <- tpi + 1
      sectdat <- indvdat[indvdat$TimePressure == tp & indvdat$Vagueness == v & indvdat$chosenItem != 3 & !is.nan(indvdat$chosenItem),]
      acc <- aggregate(choice ~ ID3, data = sectdat, FUN = mean)
      colnames(acc) <- c('ID3','acc')
      acc$acc <- acc$acc*100
      V3scld <- aggregate(V3scld ~ ID3, data = sectdat, FUN = mean)
      sdbid <- aggregate(sdbid3scld ~ ID3, data = sectdat, FUN = mean)
      Ntrial <- aggregate(trial ~ ID3, data = sectdat, FUN = length)
      VDscld <- aggregate(VDscld ~ ID3, data = sectdat, FUN = mean)
      colnames(Ntrial) <- c('ID3','Ntrial')
      onesect <- merge(acc, V3scld, by = 'ID3')
      onesect <- merge(onesect, sdbid, by = 'ID3')
      onesect <- merge(onesect, Ntrial, by = 'ID3')
      onesect <- merge(onesect, VDscld, by = 'ID3')
      AccID3 <- rbind(AccID3, data.frame(subID = subID[s], Vagueness = v, TimePressure = tp, onesect))
    }
  }
}
write.table(AccID3, file = file.path('/Users/bs3667/Dropbox (NYU Langone Health)/CESS-Bo/myData', 'AccID3.txt'), quote = FALSE, sep = "\t", eol = "\n", row.names = FALSE)
```

## Statistical testing, conditional choice accuracy over scaled V3
```{r}
library(sandwich) # packages for adjusting statistical inference on the cluster of subjects
library(lmtest)
# by excluding those subjects who show a negative logistic slope
blacklist <- c('22102708', '22071913', '22110306', '22102405', '22102705', '22071903', '22102703', '22071904', '22102704', '22072003', '22102401', '22071912', '22102503','22102702')

LowestV3 <- 0.2
HighestV3 <- .8
## Method 1: test based on the experimental conditions
# mixed model lacks power to reach significance
# summary(test <- glmer(choice ~ Vagueness + TimePressure + V3scld + V3scld:Vagueness + V3scld:TimePressure + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
# summary(test <- glmer(choice ~ Vagueness + TimePressure + V3:Vagueness:TimePressure + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
# test on pooled data reveal significant impacts of vagueness on overall accuracy as well as contextual slope
summary(test <- glm(choice ~ V3scld + Vagueness + TimePressure + V3scld:Vagueness + V3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
summary(test <- glm(choice ~ VDscld + V3scld + Vagueness + TimePressure + V3scld:Vagueness + V3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,]))
coeftest(test, vcov = vcovCL(test, cluster = ~subID))
#                        Estimate Std. Error z value Pr(>|z|)    
# (Intercept)             0.77098    0.12488   6.174 6.67e-10 ***
# V3scld                 -0.26119    0.24418  -1.070   0.2848    
# VaguenessVague         -0.26039    0.14118  -1.844   0.0651 .  
# TimePressureLow         0.02188    0.14060   0.156   0.8764    
# V3scld:VaguenessVague   0.59162    0.28320   2.089   0.0367 *  
# V3scld:TimePressureLow  0.27890    0.28229   0.988   0.3232  
# z test of coefficients:
# 
#                         Estimate Std. Error z value  Pr(>|z|)    
# (Intercept)             0.770980   0.212858  3.6220 0.0002923 ***
# V3scld                 -0.261194   0.352371 -0.7412 0.4585433    
# VaguenessVague         -0.260394   0.147117 -1.7700 0.0767305 .  
# TimePressureLow         0.021875   0.099660  0.2195 0.8262604    
# V3scld:VaguenessVague   0.591621   0.307297  1.9252 0.0541996 .  
# V3scld:TimePressureLow  0.278897   0.210924  1.3223 0.1860800 
# post-hoc to see the linear trend of each condition
summary(test <- glm(choice ~ Vagueness + TimePressure + V3scld:Vagueness:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
coeftest(test, vcov = vcovCL(test, cluster = ~subID))
# VaguenessVague                           -0.26067    0.14119  -1.846   0.0649 .  
# TimePressureLow                           0.02054    0.14079   0.146   0.8840    
# VaguenessPrecise:TimePressureHigh:V3scld -0.25518    0.24652  -1.035   0.3006    
# VaguenessVague:TimePressureHigh:V3scld    0.31927    0.24940   1.280   0.2005    
# VaguenessPrecise:TimePressureLow:V3scld   0.00915    0.25467   0.036   0.9713    
# VaguenessVague:TimePressureLow:V3scld     0.61920    0.24949   2.482   0.0131 *  
# z test of coefficients:
# 
#                                            Estimate Std. Error z value  Pr(>|z|)    
# (Intercept)                               0.7721902  0.2132208  3.6216 0.0002928 ***
# VaguenessVague                           -0.2606695  0.1470312 -1.7729 0.0762476 .  
# TimePressureLow                           0.0205426  0.0987919  0.2079 0.8352773    
# VaguenessPrecise:TimePressureHigh:V3scld -0.2551843  0.3514218 -0.7261 0.4677480    
# VaguenessVague:TimePressureHigh:V3scld    0.3192743  0.2887666  1.1056 0.2688788    
# VaguenessPrecise:TimePressureLow:V3scld   0.0091496  0.3617494  0.0253 0.9798216    
# VaguenessVague:TimePressureLow:V3scld     0.6191957  0.3582358  1.7285 0.0839060 .  

# Perspective 2: Medium split variance of V3
summary(test <- glm(choice ~ TimePressure + V3scld + sdbidlabel + V3scld:sdbidlabel + V3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= .8,]))
# TimePressureLow         0.16359    0.05096   3.210  0.00133 ** 
# V3scld                 -0.23287    0.13950  -1.669  0.09505 .  
# sdbidlabelVague        -0.17297    0.05789  -2.988  0.00281 ** 
# V3scld:sdbidlabelVague  0.43652    0.16457   2.653  0.00799 ** 
# TimePressureLow:V3scld  0.03323    0.14280   0.233  0.81601    

## Pespective 3: test based on the item-wise variance from bidding
summary(test <- glmer(choice ~ VD + TimePressure + V3 + sdbid3 + V3:sdbid3 + V3:TimePressure + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= 1,]))

grpdcsn$ZvD <- (grpdcsn$V2 - grpdcsn$V1)/sqrt(grpdcsn$sdbid1^2 + grpdcsn$sdbid2^2)
summary(test <- glmer(choice ~ ZvD + TimePressure + V3 + Vagueness + V3:Vagueness + V3:TimePressure + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= 1,]))

summary(test <- glm(choice ~ TimePressure + V3scld + sdbid3scld + V3scld:sdbid3scld + V3scld:TimePressure + sdbid3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= .8,]))
# TimePressureLow             0.16800    0.05137   3.271  0.00107 ** 
# V3scld                     -0.28765    0.12145  -2.368  0.01786 *  
# sdbid3scld                 -1.70403    0.32481  -5.246 1.55e-07 ***
# V3scld:sdbid3scld           3.50465    0.57443   6.101 1.05e-09 ***
# TimePressureLow:V3scld      0.20903    0.16402   1.274  0.20252    
# TimePressureLow:sdbid3scld -0.45737    0.23429  -1.952  0.05092 .  
coeftest(test, vcov = vcovCL(test, cluster = ~subID))
# TimePressureLow             0.168004   0.049655  3.3834  0.000716 ***
# V3scld                     -0.287651   0.226928 -1.2676  0.204946    
# sdbid3scld                 -1.704029   1.243052 -1.3708  0.170424    
# V3scld:sdbid3scld           3.504647   2.013488  1.7406  0.081756 .  
# TimePressureLow:V3scld      0.209029   0.145307  1.4385  0.150282    
# TimePressureLow:sdbid3scld -0.457367   0.161029 -2.8403  0.004507 ** 
summary(test <- glm(choice ~ TimePressure + V3scld + sdbid3scld + V3scld:sdbid3scld + V3scld:TimePressure + sdbid3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= 1,]))
#                            Estimate Std. Error z value Pr(>|z|)    
# (Intercept)                 0.72344    0.03584  20.185  < 2e-16 ***
# TimePressureLow             0.17260    0.04857   3.554  0.00038 ***
# V3scld                     -0.17668    0.08913  -1.982  0.04745 *  
# sdbid3scld                 -1.04152    0.22774  -4.573  4.8e-06 ***
# V3scld:sdbid3scld           1.69534    0.27657   6.130  8.8e-10 ***
# TimePressureLow:V3scld      0.06532    0.12357   0.529  0.59707    
# TimePressureLow:sdbid3scld -0.19723    0.17188  -1.148  0.25116   
coeftest(test, vcov = vcovCL(test, cluster = ~subID))
# TimePressureLow             0.172601   0.051141  3.3750 0.0007382 ***
# V3scld                     -0.176683   0.170124 -1.0386 0.2990106    
# sdbid3scld                 -1.041517   0.812107 -1.2825 0.1996719    
# V3scld:sdbid3scld           1.695336   1.002209  1.6916 0.0907224 .  
# TimePressureLow:V3scld      0.065320   0.100604  0.6493 0.5161616    
# TimePressureLow:sdbid3scld -0.197235   0.170675 -1.1556 0.2478379  

summary(test <- glm(choice ~ V3scld*TimePressure*sdbid3scld, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= .8,]))
# V3scld                            -0.24105    0.12545  -1.921 0.054679 .  
# TimePressureLow                    0.20267    0.05676   3.571 0.000356 ***
# sdbid3scld                        -1.34293    0.41123  -3.266 0.001092 ** 
# V3scld:TimePressureLow             0.11463    0.17670   0.649 0.516521    
# V3scld:sdbid3scld                  2.76514    0.76836   3.599 0.000320 ***
# TimePressureLow:sdbid3scld        -1.27412    0.61450  -2.073 0.038135 *  
# V3scld:TimePressureLow:sdbid3scld  1.66353    1.15781   1.437 0.150779    
coeftest(test, vcov = vcovCL(test, cluster = ~subID))
# V3scld                            -0.241047   0.229137 -1.0520  0.292809    
# TimePressureLow                    0.202672   0.055627  3.6434  0.000269 ***
# sdbid3scld                        -1.342935   1.254965 -1.0701  0.284576    
# V3scld:TimePressureLow             0.114626   0.148175  0.7736  0.439175    
# V3scld:sdbid3scld                  2.765141   2.048890  1.3496  0.177151    
# TimePressureLow:sdbid3scld        -1.274115   0.580121 -2.1963  0.028071 *  
# V3scld:TimePressureLow:sdbid3scld  1.663527   1.021900  1.6279  0.103551 

summary(test <- glm(choice ~ VDscld + TimePressure + V3scld + sdbid3scld + V3scld:sdbid3scld + V3scld:TimePressure + TimePressure:sdbid3scld + V3scld:TimePressure:sdbid3scld, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= 1,]))
# VDscld                             0.101927   0.009747  10.457  < 2e-16 ***
# TimePressureLow                    0.209298   0.053256   3.930 8.49e-05 ***
# V3scld                             0.019188   0.091637   0.209   0.8341    
# sdbid3scld                        -0.721984   0.296595  -2.434   0.0149 *  
# V3scld:sdbid3scld                  0.771203   0.381088   2.024   0.0430 *  
# TimePressureLow:V3scld             0.005166   0.128359   0.040   0.9679    
# TimePressureLow:sdbid3scld        -0.909202   0.430468  -2.112   0.0347 *  
# TimePressureLow:V3scld:sdbid3scld  1.033819   0.563500   1.835   0.0666 .   

# test TimePressure effect on precise distracters only
summary(test <- glm(choice ~ TimePressure + V3scld + V3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= HighestV3 & grpdcsn$sdbid3scld < .08,]))

summary(test <- glm(choice ~ TimePressure + V3scld + V3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0.2 & grpdcsn$V3scld <= HighestV3 & grpdcsn$sdbid3scld > .4 & grpdcsn$sdbid3scld < .5,]))

summary(test <- glm(choice ~ V3scld*sdbid3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld <= HighestV3 & grpdcsn$sdbid3scld <= 1,]))
summary(test <- glm(choice ~ V3scld*sdbid3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld <= HighestV3,]))
summary(test <- glm(choice ~ V3scld*sdbid3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld <= HighestV3 & grpdcsn$sdbid3scld > .4,]))

summary(test <- glm(choice ~ V3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= 0.2 & grpdcsn$V3scld <= .8 & grpdcsn$sdbid3scld < .15 ,]))

summary(test <- glm(choice ~ V3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= .1 & grpdcsn$V3scld <= .7 & grpdcsn$sdbid3scld > .34 & grpdcsn$sdbid3scld <.5,]))


######
summary(aov_model <- aov(acc ~ TimePressure*V3scld*sdbid3scld + Error(subID), data = AccID3[AccID3$V3scld >= .2 & AccID3$V3scld <= .8,]))
summary(lmer_model <- lmer(acc ~ TimePressure*V3scld*sdbid3scld + (1|subID), data = AccID3[AccID3$V3scld >= .2 & AccID3$V3scld <= .8,]))
summary(lmer_model <- lmer(acc ~ TimePressure*V3scld*sdbid3scld + (1|subID), data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= .8,]))
summary(lmer_model <- lmer(acc ~ TimePressure*V3scld*sdbid3scld + (1|subID), data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= 1,]))

summary(aov_model <- aov(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= .2 & AccID3$V3scld <= .8,]))
summary(aov_model <- aov(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= .8,]))
summary(aov_model <- aov(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= 1,]))

summary(lm_model <- lm(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= .2 & AccID3$V3scld <= .8,]))
summary(lm_model <- lm(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= .8,]))
summary(lm_model <- lm(acc ~ V3scld*TimePressure*Vagueness, data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= 1,]))
coeftest(lm_model, vcov = vcovCL(lm_model, cluster = ~subID))

summary(lmer_model <- lmer(acc ~ V3scld*TimePressure*Vagueness + (1|subID), data = AccID3[AccID3$V3scld >= .2 & AccID3$V3scld <= .8,]))
summary(lmer_model <- lmer(acc ~ V3scld*TimePressure*Vagueness + (1|subID), data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= .8,]))
summary(lmer_model <- lmer(acc ~ V3scld*TimePressure*Vagueness + (1|subID), data = AccID3[AccID3$V3scld >= 0 & AccID3$V3scld <= 1,]))

# test include VD or VDscld
summary(lm1 <- glmer(choice ~ VD + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0),]))
summary(lm2 <- glmer(choice ~ VDscld + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0),]))

# let's see if that was because of the intercept effect. Yes, the effect still remains, thought less significant
summary(lmtest3 <- glmer(choice ~ VDscld + VDscld:V3 + VDscld:TimePressure + VDscld:Vagueness + VDscld:V3:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0),]))


# marginal significance
summary(lmtest3 <- glmer(choice ~ VDscld + VDscld:V3:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,]))

# let's see if that was because of the intercept effect. Yes, the effect still remains, thought less significant
summary(lmtest3 <- glmer(choice ~ VDscld + VDscld:V3 + VDscld:TimePressure + VDscld:Vagueness + VDscld:V3:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,]))

# marginal significance, closely follow the pattern
lmtest3 <- glmer(choice ~ VDscld + VDscld:V3:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist,])
summary(lmtest3)



# let's see if that was because of the intercept effect. Yes, the effect still remains, thought less significant
lmtest3 <- glmer(choice ~ VDscld + VDscld:V3scld + VDscld:TimePressure + VDscld:Vagueness + VDscld:V3scld:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !grpdcsn$subID %in% blacklist,])
summary(lmtest3)

contrasts(grpdcsn$TimePressure) <- contr.sum(levels(grpdcsn$TimePressure))
contrasts(grpdcsn$Vagueness) <- contr.sum(levels(grpdcsn$Vagueness))


summary(lmtest3 <- glm(choice ~ V3scld + Vagueness + V3scld:Vagueness + V3scld:TimePressure, family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,]))


# What if to capture the choice accuracy regardless of the target-value differences?
lmtest3x <- glmer(choice ~ V3*Vagueness*TimePressure + (1|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !grpdcsn$subID %in% blacklist,])
summary(lmtest3x)

# see interactions
contrasts(grpdcsn$TimePressure) <- contr.treatment(levels(grpdcsn$TimePressure))
contrasts(grpdcsn$Vagueness) <- contr.treatment(levels(grpdcsn$Vagueness))
model <- glmer(
  choice ~ VDscld + V3scld + V3scld:TimePressure + (1 + VDscld | subID),
  data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist,], # & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
summary(model)

model <- glmer(
  choice ~ VDscld + V3scld + Vagueness*TimePressure + VDscld:Vagueness + VDscld:TimePressure + V3scld:Vagueness + V3scld:TimePressure + VDscld:V3scld:(Vagueness*TimePressure)  + (1 + VDscld | subID),
  data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) ,], # & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist
  family = binomial(link = "logit")
)
summary(model)


summary(test <- glmer(choice ~ VDscld + V3scld + TimePressure + Vagueness + V3scld:TimePressure + V3scld:Vagueness + V3scld:TimePressure:Vagueness + (VDscld|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8,]))


LowestV3 <- .2
HighestV3 <- .8
summary(test <- glmer(choice ~ V3scld*varbid3scld + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$TimePressure == 'Low' & grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
summary(test <- glm(choice ~ V3scld*varbid3scld, family = "binomial", data = grpdcsn[grpdcsn$TimePressure == 'Low' & grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))

summary(test <- glmer(choice ~ V3scld*varbid3scld + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$TimePressure == 'High' & grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
summary(test <- glm(choice ~ V3scld*varbid3scld, family = "binomial", data = grpdcsn[grpdcsn$TimePressure == 'High' & grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))

summary(test <- glmer(choice ~ VDscld + V3scld + V3scld:varbid3scld + varbid3scld + TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3 & grpdcsn$varbid3scld <= .2,]))
# Correlation of Fixed Effects:
#             (Intr) VDscld V3scld vrbd3s TmPrs1
# VDscld      -0.429                            
# V3scld      -0.619 -0.004                     
# varbid3scld -0.327  0.001  0.326              
# TimePressr1  0.010 -0.004  0.005 -0.023       
# V3scld:vrb3  0.325  0.000 -0.393 -0.966  0.014
contrasts(grpdcsn$TimePressure) <- contr.treatment(levels(grpdcsn$TimePressure))
summary(test <- glm(choice ~ V3scld + varbid3scld + TimePressure + V3scld:varbid3scld, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3 & grpdcsn$varbid3scld <= .2,]))
summary(test <- glm(choice ~ V3scld*varbid3scld*TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3 & grpdcsn$varbid3scld <= .2,]))
require(car)
vif(test)


# summary(test <- glmer(choice ~ V3*varbid3 + TimePressure + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
# summary(test <- glm(choice ~ V3*varbid3 + TimePressure , family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
# Model failed to converge with max|grad| = 0.079571 (tol = 0.002, component 1)
# Model is nearly unidentifiable: very large eigenvalue
#  - Rescale variables?
# Model is nearly unidentifiable: large eigenvalue ratio
#  - Rescale variables?

summary(test <- lmer(varbid3scld ~ V3scld + (V3scld|subID), data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3 & grpdcsn$varbid3scld <= .4,]))
summary(test <- lm(varbid3scld ~ V3scld, data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3 & grpdcsn$varbid3scld <= .4,]))

# test context variance given the data instead of conditions
medval <- median(grpdcsn$varbid3scld[grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3])
grpdcsn$VaguenessData <- grpdcsn$varbid3scld > medval
summary(test <- glm(choice ~ V3scld + VaguenessData + TimePressure + V3scld:VaguenessData, data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
vif(test)
summary(mxtest <- glmer(choice ~ V3scld + VaguenessData + TimePressure + V3scld:VaguenessData + (1|subID), family = binomial, data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))

# test like the experiment
summary(test <- glm(choice ~ VaguenessData + TimePressure + V3scld + V3scld:VaguenessData + V3scld:TimePressure, data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))
summary(test <- glm(choice ~ VaguenessData + TimePressure + V3scld:VaguenessData:TimePressure, data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= LowestV3 & grpdcsn$V3scld <= HighestV3,]))


# see the trends of four conditions by regression
# That works! With and without blacklist subjects! set or release the middle range v3scld!
grpdcsn$Conditions <- as.numeric(grpdcsn$Conditions)
model <- glmer(
  choice ~ VDscld + V3scld + VDscld:Conditions + V3scld:Conditions + VDscld:V3scld:Conditions + (VDscld|subID),
  data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0),],
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
summary(model)


lmtest3 <- glmer(choice ~ VDscld + VDscld:Vagueness + VDscld:TimePressure  + VDscld:V3:Vagueness +   VDscld:V3:TimePressure + VDscld:V3:Vagueness:TimePressure + (VDscld|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !grpdcsn$subID %in% blacklist,])
summary(lmtest3)

lmtest4 <- glmer(choice ~ VD + VD:V3 + VD:V3:Vagueness:TimePressure + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,])
summary(lmtest4)
lmtest4 <- glmer(choice ~ VD + VD:V3 + VD:V3:Vagueness:TimePressure + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0),])
summary(lmtest4)
lmtest4 <- glmer(choice ~ VD + VD:V3 + VD:V3:Vagueness:TimePressure + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist,])
summary(lmtest4)
lmtest4 <- glmer(choice ~ VD + VD:V3 + VD:V3:Vagueness:TimePressure + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !grpdcsn$subID %in% blacklist,])
summary(lmtest4)
# let's see if that was because of the intercept effect. Yes, the effect still remains, thought less significant
lmtest4 <- glmer(choice ~ VD + VD:V3 + VD:TimePressure + VD:V3:Vagueness:TimePressure + (VD|subID) + (VD|subID), family = "binomial", data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !grpdcsn$subID %in% blacklist,])
summary(lmtest4)

# Test fixed effects
model <- glm(
  choice ~ VDscld*V3scld + Vagueness*TimePressure + VDscld:Vagueness + VDscld:TimePressure + VDscld:Vagueness:TimePressure 
  + V3scld:Vagueness + V3scld:TimePressure + V3scld:Vagueness:TimePressure +  VDscld:V3scld:Vagueness + VDscld:V3scld:TimePressure + VDscld:V3scld:Vagueness:TimePressure,
  data = grpdcsn[(grpdcsn$choice == 1 | grpdcsn$choice == 0) & !is.na(grpdcsn$choice) & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8,], # & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist
  family = binomial(link = "logit"))
summary(model)


# Medium split
par(mfrow = c(2,2))
CHRMsplt <- c()
for (tp in c('High','Low'))
{
  for (vague in c('Precise','Vague'))
  {
    if (vague == 'Vague' & tp == 'Low'){mycol <- 'red'}
    if (vague == 'Precise' & tp == 'High'){mycol <- 'blue'}
    if (vague == 'Precise' & tp == 'Low'){mycol <- '#00FF80'}
    if (vague == 'Vague' & tp == 'High'){mycol <- '#FFBF00'}
    
    for (si in subjlist[!subjlist %in% blacklist]) # 
    {
      sectdat <- grpdcsn[grpdcsn$subID == si & grpdcsn$TimePressure == tp & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8 & grpdcsn$Vagueness == vague,]
      v3m <- median(sectdat$V3)
      chrL <- mean(sectdat$choice[sectdat$V3<=v3m & (sectdat$choice == 1 | sectdat$choice == 0) & !is.na(sectdat$choice)])
      chrH <- mean(sectdat$choice[sectdat$V3>=v3m & (sectdat$choice == 1 | sectdat$choice == 0) & !is.na(sectdat$choice)])
      CHRMsplt <- rbind(CHRMsplt, data.frame(subID = si, TimePressure = tp, Vagueness = vague, chrL = chrL, chrH = chrH))
    }
    plot(chrH ~ chrL, data = CHRMsplt[CHRMsplt$TimePressure == tp & CHRMsplt$Vagueness == vague,], pch = 20, main = sprintf('%s %s',tp, vague), col=mycol)
    abline(0,1, lty = 2)
    test <- t.test(CHRMsplt[CHRMsplt$TimePressure == tp & CHRMsplt$Vagueness == vague,]$chrH-CHRMsplt[CHRMsplt$TimePressure == tp & CHRMsplt$Vagueness == vague,]$chrL)
    text(.7, .4, sprintf('t(%i) = %1.2f, p = %1.3f',test$parameter["df"], test$statistic, test$p.value))
  }
}
dev.copy(pdf,file.path(out_dir,'ChoiceRatioMediumSplit[PositiveLogisticSubjects].pdf'), height=7, width=7) # 
dev.off()


## visualizing V3 distributions
library(RColorBrewer)
# Generate a palette with 55 colors
palette_55 <- colorRampPalette(brewer.pal(9, "Set1"))(55)
par(mfrow = c(2,2))
V3scldCvrg <- c()
for (tp in c('High','Low'))
{
  for (vague in c('Precise','Vague'))
  {
    plot(c(0,1), c(0,0), ylim = c(0,56), type = 'l', lty = 2, main = sprintf('%s, %s',tp, vague), xlab = 'V3 scaled', ylab = 'Subjects')
    i <- 0
    for (si in subjlist)
    {
      i <- i + 1
      sectdat <- grpdcsn[grpdcsn$subID == si & grpdcsn$TimePressure == tp & grpdcsn$Vagueness == vague,]
      v3 <- unique(sectdat$V3scld)
      V3scldCvrg <- rbind(V3scldCvrg, data.frame(subID = si, TimePressure = tp, Vagueness = vague, V3 = v3))
      lines(c(0,1), c(i,i), lty = 1, lwd = .2, col = palette_55[i])
      points(v3, rep(i,length(v3)), pch = 20, cex = .5, col = palette_55[i])
    }
  }
}
dev.copy(pdf,file.path(out_dir,'V3scaledtomin~subID.pdf'), height=10, width=3.47*2)
dev.off()
# sort the subjects based on the mean values of V3scaled

SlctSubjs <- c()
plot(c(0,1), c(0,0), ylim = c(0,56), type = 'l', lty = 2, main = sprintf('%s, %s',tp, vague), xlab = 'V3 scaled', ylab = 'Subjects')
V3scld <- V3scldCvrg
meanv3 <- aggregate(V3 ~ subID, data = V3scld, FUN = mean)
meanv3 <- meanv3[order(meanv3$V3),]
slctlist <- meanv3$subID[meanv3$V3>.35 & meanv3$V3<.6]
SlctSubjs <- slctlist
i <- 0
for (so in meanv3$subID)
{
  i <- i + 1
  v3 <- V3scld[V3scld$subID == so,]$V3
  lines(c(0,1), c(i,i), lty = 1, lwd = .2, col = palette_55[i])
  points(v3, rep(i,length(v3)), pch = 20, cex = .5, col = palette_55[i])
  if (so %in% slctlist)
  {text(1,i, '*', col = 2)}
}
dev.copy(pdf,file.path(out_dir,'V3scaledtomin~subID[sort].pdf'), height=5, width=3.47)
dev.off()

# Pool subjects, choice accuracy as scaled V3
AccID3 <- c()
Rgress <- c()
vi <- 0
for (v in c('Precise','Vague')) # decision noise
{
  vi <- vi + 1
  tpi <- 0
  for (tp in c('High','Low')) # representation noise
  {
    if (v == 'Vague' & tp == 'Low'){mycol <- 'blue'}
    if (v == 'Precise' & tp == 'High'){mycol <- 'pink'}
    if (v == 'Precise' & tp == 'Low'){mycol <- 'red'}
    if (v == 'Vague' & tp == 'High'){mycol <- 'lightblue'}
    tpi <- tpi + 1
    
    slctlist <- SlctSubjs#$subID[SlctSubjs$TimePressure == tp & SlctSubjs$Vagueness == v]
    sectdat <- grpdcsn[grpdcsn$TimePressure == tp & grpdcsn$Vagueness == v & grpdcsn$chosenItem != 3 & !is.nan(grpdcsn$chosenItem) & grpdcsn$subID %in% slctlist,]
    acc <- aggregate(choice ~ V3scld, data = sectdat, FUN = mean)
    varbid <- aggregate(varbid3scld ~ V3scld, data = sectdat, FUN = mean)
    colnames(acc) <- c('V3scld','acc')
    acc$acc <- acc$acc*100
    Ntrial <- aggregate(trial ~ V3scld, data = sectdat, FUN = length)
    colnames(Ntrial) <- c('V3scld','Ntrial')
    onesect <- merge(acc, varbid, by = 'V3scld')
    onesect <- merge(onesect, Ntrial, by = 'V3scld')
    if (vi == 1 & tpi == 1){plot(acc ~ V3scld, data = onesect, xlab = 'Scaled V3', ylab = '% Correct (V1 & V2)', pch = 20, cex = (onesect$Ntrial)/10, type = 'n', main = sprintf('%s %s', v, tp))}
    test <- lm(acc ~ V3scld, data = onesect, weights = Ntrial)
    if (!is.na(test$coefficients[2])){abline(test, col = mycol)}
    Rgress <- rbind(Rgress, data.frame(Vagueness = v, TimePressure = tp, t(test$coefficients)))
    AccID3 <- rbind(AccID3, data.frame(Vagueness = v, TimePressure = tp, onesect))
  }
}
# Sliding windows, weighted, including zero
condlist <- c(1,4,2,3)
condnames <- c('Vague-Low','Precise-Low','Vauge-High','Precise-High')
condcolors <- c('red','#00FF80','#FFBF00','blue')
vaguevec <- c('Vague','Precise','Vague','Precise')
timevec <- c('Low','Low','High','High')
LowestV3 <- 0 # chose V3 higher than zero, to avoid the effect when V3 = 0, the early noise cannot be effectively regulated
HighestV3 <- 1
Sldwndwdat <- c()
i <- 0
for (ci in condlist) # decision noise
{
  i <- i + 1
  v <- vaguevec[ci]
  tp <- timevec[ci]
  if (v == 'Vague' & tp == 'Low'){mycol <- 'red'}
  if (v == 'Precise' & tp == 'High'){mycol <- 'blue'}
  if (v == 'Precise' & tp == 'Low'){mycol <- '#00FF80'}
  if (v == 'Vague' & tp == 'High'){mycol <- '#FFBF00'}
  onesect <- AccID3[AccID3$Vagueness == v & AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
  acc <- c()
  Ntrial <- c()
  v3vec <- seq(LowestV3, 1, .015)
  for (v3 in v3vec)
  {
    mask <- onesect$V3scld > v3 -.15 & onesect$V3scld < v3 + .15
    Ntrial <- rbind(Ntrial, sum(onesect$Ntrial[mask]))
    # Ntrial <- rbind(Ntrial, sum(mask)*15)
    acc <- rbind(acc, weighted.mean(onesect[mask,]$acc,onesect[mask,]$Ntrial))
  }
  cut <- Ntrial > 200
  Sldwndwdat <- rbind(Sldwndwdat, data.frame(v3 = v3vec[cut], acc = acc[cut], Ntrial = Ntrial[cut], TimePressure = tp, Vagueness = v))
  if (i == 1)
  {plot(v3vec[cut], acc[cut], cex = (Ntrial[cut])/800, col = mycol, 
        xlim = c(-.03, 1), ylim = c(60,74), xlab=' ', ylab=' ', 
        axes = FALSE, frame.plot = FALSE)
    axis(1, at = c(seq(LowestV3, 1, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
    axis(2, tck = -0.02, at = seq(60, 75, 3), padj = 1, cex.axis = 1)
    title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  }else{points(v3vec[cut], acc[cut], cex = (Ntrial[cut])/800, col = mycol)}
  lines(v3vec[cut], acc[cut], col = mycol)
  slctlist <- SlctSubjs#$subID[SlctSubjs$TimePressure == tp & SlctSubjs$Vagueness == v]
  Nsubj <- length(slctlist)
  text(.03, acc[1], sprintf('N = %i',Nsubj), col = mycol)
}
dev.copy(pdf, file.path(out_dir,sprintf("Choice~IDV3scldtomin_SldWndwWght_with0[SubjectMask].pdf")), height=6.28, width=5.86)
dev.off()
# mask the data and do statistics again
Slctdat <- c()
for (tp in c('High','Low'))
{
  for (vague in c('Precise','Vague'))
  {
    slctlist <- SlctSubjs#$subID[SlctSubjs$TimePressure == tp & SlctSubjs$Vagueness == vague]
    Slctdat <- rbind(Slctdat, grpdcsn[grpdcsn$TimePressure == tp & grpdcsn$Vagueness == vague & grpdcsn$subID %in% slctlist,])
  }
}
model <- glmer(
  choice ~ VDscld + V3scld + TimePressure + Vagueness + V3scld:TimePressure + V3scld:Vagueness + VDscld:Vagueness + VDscld:TimePressure + (0 + VDscld | subID),
  data = Slctdat[(Slctdat$choice == 1 | Slctdat$choice == 0) & !is.na(Slctdat$choice),], # & grpdcsn$V3scld >= .2 & grpdcsn$V3scld <= .8
  family = binomial(link = "logit"))
summary(model)

AccID3Indv <- c()
Rgress <- c()
for (v in c('Precise','Vague')) # decision noise
{
  for (tp in c('High','Low')) # representation noise
  {
    slctlist <- SlctSubjs#$subID[SlctSubjs$TimePressure == tp & SlctSubjs$Vagueness == vague]
    for (so in slctlist)
    {
      indvdat <- grpdcsn[grpdcsn$subID == so,]
      sectdat <- indvdat[indvdat$TimePressure == tp & indvdat$Vagueness == v & indvdat$chosenItem != 3 & !is.na(indvdat$chosenItem),]
      v3ID <- unique(sectdat$ID3)
      acc <- aggregate(choice ~ ID3, data = sectdat, FUN = mean)
      colnames(acc) <- c('ID3','acc')
      Ntrial <- aggregate(trial ~ ID3, data = sectdat, FUN = length)
      colnames(Ntrial) <- c('ID3','Ntrial')
      bid <- aggregate(V3scld ~ ID3, data = sectdat, FUN = mean)
      onesect <- merge(acc, bid, by = 'ID3')
      onesect <- merge(onesect, Ntrial, by = 'ID3')
      test <- lm(acc ~ V3scld, data = onesect, weights = Ntrial)
      Rgress <- rbind(Rgress, data.frame(subID = so, Vagueness = v, TimePressure = tp, t(test$coefficients)))
      AccID3Indv <- rbind(AccID3Indv, data.frame(subID = so, Vagueness = v, TimePressure = tp, onesect))
    }
  }
}
# par(mfrow = c(2,2))
# Rgress$Vagueness <- factor(Rgress$Vagueness, levels = levels(grpdcsn$Vagueness))
# Rgress$TimePressure <- factor(Rgress$TimePressure, levels = levels(grpdcsn$TimePressure))
plot(Rgress$V3scld[Rgress$Vagueness == 'Precise' & Rgress$TimePressure == 'High'], Rgress$V3scld[Rgress$Vagueness == 'Vague' & Rgress$TimePressure == 'Low'], pch = 20, xlab = 'Precise & High Pressure', ylab = 'Vague & Low Pressure')
lines(c(-1,1),c(0,0), lty = 2)
lines(c(0,0),c(-1,1), lty = 2)

# Sliding windows, weighted, Accuracy normalized within subjects

AccID3norm <- AccID3Indv
for (si in unique(AccID3norm$subID))
{
  indvmask <- AccID3norm$subID == si
  accsect <- aggregate(acc ~ V3scld, data = AccID3norm[indvmask,], FUN = mean)
  smlestacc <- accsect$acc[accsect$V3scld == min(accsect$V3scld)]
  meanacc <- mean(AccID3norm[indvmask,]$acc)
  AccID3norm$acc[indvmask] <- AccID3norm$acc[indvmask] - meanacc #smlestacc
}

Sldwndwdat <- c()
for (v in c('Precise','Vague')) # decision noise
{
  for (tp in c('High','Low')) # representation noise
  {
    if (v == 'Vague' & tp == 'Low'){mycol <- 'red'}
    if (v == 'Precise' & tp == 'High'){mycol <- 'blue'}
    if (v == 'Precise' & tp == 'Low'){mycol <- '#00FF80'}
    if (v == 'Vague' & tp == 'High'){mycol <- '#FFBF00'}
    onesect <- AccID3norm[AccID3norm$Vagueness == v & AccID3norm$TimePressure == tp,] #  & AccID3$V3scld > 0.2
    acc <- c()
    Ntrial <- c()
    v3vec <- seq(0,1,.015)
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 -.15 & onesect$V3scld < v3 + .15
      Ntrial <- rbind(Ntrial, sum(mask)*15)
      acc <- rbind(acc, weighted.mean(onesect[mask,]$acc,onesect[mask,]$Ntrial))
    }
    cut <- Ntrial > 200
    Sldwndwdat <- rbind(Sldwndwdat, data.frame(v3 = v3vec[cut], acc = acc[cut], Ntrial = Ntrial[cut], TimePressure = tp, Vagueness = v))
    
    if (v == 'Precise' & tp == 'High'){plot(v3vec[cut], acc[cut], cex = (Ntrial[cut])/600, col = mycol, xlim = c(0, 1.1), ylim = c(-.07,.04), xlab = 'Sliding window on scaled V3', ylab = '% Correct | (1, 2)')}else{points(v3vec[cut], acc[cut], cex = (Ntrial[cut])/600, col = mycol)}
    lines(v3vec[cut], acc[cut], col = mycol)
    test <- lm(acc[cut] ~ v3vec[cut], weights = Ntrial[cut])
    abline(test, col = mycol)
  }
}
legend('bottomleft',c('Vague-Low','Precise-Low','Vauge-High','Precise-High'), cex = .8, text.col = c('red','#00FF80','#FFBF00','blue'), bty = 'n')
dev.copy(pdf,file.path(out_dir,sprintf("ChoiceDeMean~IDV3scldtomin_SldWndwWght[SubjectMask].pdf")),height=6.28, width=5.86)
dev.off()

```

# Statistics on bidding behavior, reveal mean-scaled noise
```{r, echo=FALSE}
meanbid <- aggregate(bid ~ item + touched + subID, FUN = mean, data = grpbid)
names(meanbid)[4] <- 'meanbid'
sdbid <- aggregate(bid ~ item + touched + subID, FUN = sd, data = grpbid)
names(sdbid)[4] <- 'sdbid'
mrgdat <- merge(meanbid, sdbid, by = c('subID','item','touched'))

require(lmerTest)
# testing on the bidding variance
summary(Rgtest <- lmer(sdbid ~ meanbid * touched + (1|subID), data = mrgdat))
# test whether noisy item have lower bid values
summary(test <- aov(meanbid ~ touched + Error(subID), data = mrgdat))

# test on V3 only
# variance-mean relationship
tmpdat <- aggregate(sdbid3 ~ V3 + ID3 + Vagueness + subID, FUN = mean, data = grpdcsn)
summary(Rgtest <- lmer(sdbid3 ~ V3 * Vagueness + (1|subID), data = tmpdat))
# Does vague V3 have lower values?
summary(test <- aov(V3 ~ Vagueness + Error(subID), data = tmpdat))
# Were vague V3 chosen less?
tmpdat <- grpdcsn
tmpdat$chosenV3 <- as.numeric(tmpdat$chosenItem == 3)
ChrV3 <- aggregate(chosenV3 ~ Vagueness + subID, data = tmpdat, FUN = mean)
summary(test <- aov(chosenV3 ~ Vagueness + Error(subID), data = ChrV3))
```

# Visualize bidding behavior
```{r}
redtrnsp <- rgb(255,0,0,50, maxColorValue = 255)
bluetrnsp <- rgb(0,0,255,50, maxColorValue = 255)
# group overlay
for (s in 1:length(subjlist))
{
  indvdat <- mrgdat[mrgdat$subID == subjlist[s],]
  patchdat <- indvdat[indvdat$touched == 1,]
  if (s == 1){plot(patchdat$meanbid, patchdat$sdbid, pch = 20, col = bluetrnsp, xlab = ' ', ylab = ' ', xlim = c(0,90), ylim = c(0,sqrt(500)), frame.plot = TRUE, axes = FALSE,  xaxt = "n", yaxt = "n")}else{points(patchdat$meanbid,patchdat$sdbid, pch = 20, col = bluetrnsp)}
  abline(lm(sdbid ~ meanbid, data = patchdat), col = bluetrnsp)
}
patchdat <- mrgdat[mrgdat$touched == 1,]
abline(lm(sdbid ~ meanbid, data = patchdat), col = 'blue', lwd = 3)
axis(1, at = c(seq(0,90,20)),  tck = -0.02, padj = -1, cex.axis = 1)
axis(2, tck = -0.02, at = c(seq(0,22,10)), padj = 1, cex.axis = 1)
title(ylab = 'Standard deviation of bid', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
title(xlab = "Bid mean ($)", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
dev.copy(pdf,file.path(out_dir,sprintf("Paper_BidSd_A.pdf")),height=3.9, width=3.5)
dev.off()
for (s in 1:length(subjlist))
{
  indvdat <- mrgdat[mrgdat$subID == subjlist[s],]
  patchdat <- indvdat[indvdat$touched == 0,]
  points(patchdat$meanbid, patchdat$sdbid, pch = 20, col = redtrnsp)
  abline(lm(sdbid ~ meanbid, data = patchdat), col = redtrnsp)
}
patchdat <- mrgdat[mrgdat$touched == 0,]
abline(lm(sdbid ~ meanbid, data = patchdat), col = 'red', lwd = 3)
legend('topright',c('Amgiguous','Definitive'), text.col = c('red','blue'), pch = 20, cex = .8, col = c('red','blue'))
dev.copy(pdf,file.path(out_dir,sprintf("Paper_BidSd_B.pdf")),height=3.9, width=3.5) # height=4.2, width=3.885
dev.off()
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Choice task
# Manipulation check, 2x2 design
```{r}
mtest <- lmer(choice ~ Vagueness*TimePressure + (1|subID), data = grpdcsn[grpdcsn$choice == 1 | grpdcsn$choice == 0,])
summary(mtest)
bars <- aggregate(choice ~ Vagueness + TimePressure + subID, data = grpdcsn[grpdcsn$choice == 1 | grpdcsn$choice == 0,], FUN = mean)
test <- aov(choice ~ TimePressure*Vagueness + Error(subID), data = bars)
summary(test)

means <- aggregate(choice ~ Vagueness + TimePressure, data = bars, FUN = mean)
means <- means[c(4,3,2,1),]
ses <- aggregate(choice ~ Vagueness + TimePressure, data = bars, FUN = sd)
Ns <-  aggregate(choice ~ Vagueness + TimePressure, data = bars, FUN = length)
ses < ses[c(4,3,2,1),]
Ns <- Ns[c(4,3,2,1),]
ses$choice <- ses$choice/sqrt(Ns$choice)
barx <- barplot(cbind(means$choice[means$TimePressure=='Low'], means$choice[means$TimePressure=='High'])-0.5, beside = TRUE, names = c('Low','High'), col = c('red','#00FF80','#FFBF00','blue'), xlab = 'Time Pressure', ylab = '', yaxt = 'n', ylim = c(-.1,.51)) #ylim = c(-.1,.6))
legend('topright', c('','','Ambiguous','Definitive'), col = c('red','#00FF80','#FFBF00','blue'), bty = 'n', pch = 15, ncol = 2)
axis(2, at = seq(0,.2,.05), labels = seq(50,70,5), tck = -0.02, padj = .7, cex.axis = 1.0, lwd = 1.4)
# axis(2, at = seq(0,.4,.1), labels = seq(50,90,10), tck = -0.03, padj = .7, cex.axis = 1.0, lwd = 1.4)
title(ylab = expression(paste('% Correct | V1, V2                ')), mgp = c(2,0,0), font.lab = 1, cex.lab = 1.0)
abline(h = 0, lty = 2, col = 8)
arrows(barx, means$choice-0.5+ses$choice, barx, means$choice-0.5-ses$choice, code = 3, angle = 90, length = 0.1)
xm <- apply(barx, 2, mean)
lines(c(barx[1,1], barx[2,1]), c(0.23, 0.23), lwd =1, col = 1)
lines(c(barx[1,2], barx[2,2]), c(.198, .198), lwd =1, col = 1)
lines(c(xm[1], xm[1], xm[2], xm[2]),c(0.23,0.27,0.27,.198))
text(mean(xm), .57,'***')
dev.copy(pdf,file.path(out_dir,'LateNoiseReg.pdf'), height=5, width=3.47)
dev.off()
```


## Check reaction time
```{r}
RTIndv <- aggregate(RT ~ TimePressure + subID, data = grpdcsn[grpdcsn$timeout == 0,], FUN = mean)
RTmean <- aggregate(RT ~ TimePressure, data = RTIndv, FUN = mean)
RTse <- aggregate(RT ~ TimePressure, data = RTIndv, FUN = sd)
RTse$RT <- RTse$RT/sqrt(length(unique(RTIndv$subID)))
t.test(RT ~ TimePressure, data = RTIndv, paired = TRUE)
t.test(RTIndv$RT[RTIndv$TimePressure == 'High'], RTIndv$RT[RTIndv$TimePressure == 'Low'], paired = TRUE)

TOIndv <- aggregate(timeout ~ TimePressure + subID, data = grpdcsn, FUN = mean)
TOmean <- aggregate(timeout ~ TimePressure, data = TOIndv, FUN = mean)
TOse <- aggregate(timeout ~ TimePressure, data = TOIndv, FUN = sd)
TOse$se <- TOse$timeout/sqrt(length(unique(TOIndv$subID)))
```

## Check between-subjects variance
```{r}
blacklist2 <- c('22102708', '22071913', '22110306', '22102405', '22102705', '22071903', '22102703', '22071904', '22102704', '22072003', '22102401', '22071912', '22102503','22102702')
# mixed-effects
contrasts(grpdcsn$TimePressure) <- contr.sum(levels(grpdcsn$TimePressure))
contrasts(grpdcsn$Vagueness) <- contr.sum(levels(grpdcsn$Vagueness))
summary(test <- glmer(choice ~ V3scld + TimePressure + Vagueness + V3scld:TimePressure + V3scld:Vagueness + V3scld:TimePressure:Vagueness + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8,]))
summary(lmtest3 <- glmer(choice ~  TimePressure + Vagueness + V3scld:TimePressure:Vagueness + (1|subID), family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8,])) # & !grpdcsn$subID %in% blacklist

# Fixed effects
contrasts(grpdcsn$TimePressure) <- contr.sum(levels(grpdcsn$TimePressure))
contrasts(grpdcsn$Vagueness) <- contr.sum(levels(grpdcsn$Vagueness))
summary(test <- glm(choice ~ V3scld + TimePressure + Vagueness + V3scld:TimePressure + V3scld:Vagueness + V3scld:TimePressure:Vagueness, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8,])) #  & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8 & !grpdcsn$subID %in% blacklist
summary(test <- glm(choice ~ TimePressure + Vagueness + V3scld:TimePressure:Vagueness, family = "binomial", data = grpdcsn[grpdcsn$choice!=2 & !is.na(grpdcsn$choice) & grpdcsn$V3scld >=.2 & grpdcsn$V3scld <= .8,]))

# between-subject variances
BtwnEffs <- aggregate(choice ~ subID + TimePressure + Vagueness, data = grpdcsn[!is.na(grpdcsn$choice) & grpdcsn$chosenItem != 3 & !grpdcsn$subID %in% blacklist,], FUN = mean)
tmp <- aggregate(V3scld ~ subID + TimePressure + Vagueness, data = grpdcsn[!grpdcsn$subID %in% blacklist,], FUN = mean)
BtwnEffs <- merge(BtwnEffs, tmp, by = c('subID','TimePressure','Vagueness'))
tmp <- aggregate(varbid3scld ~ subID + TimePressure + Vagueness, data = grpdcsn[!grpdcsn$subID %in% blacklist,], FUN = mean)
BtwnEffs <- merge(BtwnEffs, tmp, by = c('subID','TimePressure','Vagueness'))
summary(test <- lm(choice ~ V3scld + TimePressure + Vagueness + V3scld:TimePressure + V3scld:Vagueness + V3scld:TimePressure:Vagueness, data = BtwnEffs))

summary(test <- lm(choice ~ V3scld:TimePressure:Vagueness, data = BtwnEffs))
summary(test <- lm(choice ~ V3scld, data = BtwnEffs))
summary(test <- lm(choice ~ varbid3scld, data = BtwnEffs))


par(mfrow = c(1,2))
for (v in c('Vague','Precise')) # decision noise
{
  for (tp in c('High','Low')) # representation noise
  {
    if (v == 'Vague' & tp == 'Low'){mycol <- 'red'}
    if (v == 'Precise' & tp == 'High'){mycol <- 'blue'}
    if (v == 'Precise' & tp == 'Low'){mycol <- '#00FF80'}
    if (v == 'Vague' & tp == 'High'){mycol <- '#FFBF00'}
    onesect <- BtwnEffs[BtwnEffs$Vagueness == v & BtwnEffs$TimePressure == tp,]
    if (tp == 'High'){plot(choice ~ V3scld, data = onesect, pch = 20, col = mycol, ylab = '% Choice | V1, V2', xlab = 'Mean scaled V3')}else{points(choice ~ V3scld, data = onesect, pch = 20, col = mycol)}
    rgrss <- lm(choice ~ V3scld, data = onesect)
    show(summary(rgrss)$coefficients[8])
    abline(rgrss, col = mycol, lty = 2)
  }
}
summary(test <- aov(choice ~ V3scld + varbid3scld + TimePressure + Vagueness + Error(subID), data = BtwnEffs))
dev.copy(pdf,file.path(out_dir,sprintf("BtwnEffs_Choice~IDV3scldtomin.pdf")),height=3.9, width=7)
dev.off()


par(mfrow = c(1,1))
for (v in c('Vague','Precise')) # decision noise
{
  for (tp in c('High','Low')) # representation noise
  {
    if (v == 'Vague' & tp == 'Low'){mycol <- 'red'}
    if (v == 'Precise' & tp == 'High'){mycol <- 'blue'}
    if (v == 'Precise' & tp == 'Low'){mycol <- '#00FF80'}
    if (v == 'Vague' & tp == 'High'){mycol <- '#FFBF00'}
    onesect <- BtwnEffs[BtwnEffs$Vagueness == v & BtwnEffs$TimePressure == tp,]
    if (v == 'Vague' & tp == 'High'){plot(varbid3scld ~ V3scld, data = onesect, pch = 20, cex = .8, col = mycol, ylim = c(0,.6), xlim = c(0,1), ylab = 'Mean bid variance', xlab = 'Mean scaled V3')}else{points(varbid3scld ~ V3scld, data = onesect, pch = 20, cex = .8, col = mycol)}
    rgrss <- lm(varbid3scld ~ V3scld, data = onesect)
    show(summary(rgrss)$coefficients[8])
    abline(rgrss, col = mycol, lty = 2)
  }
}
summary(rgrss <- lm(varbid3scld ~ V3scld + TimePressure + Vagueness, data = BtwnEffs))
summary(test <- aov(varbid3scld ~ V3scld + TimePressure + Vagueness + Error(subID), data = BtwnEffs))
dev.copy(pdf,file.path(out_dir,sprintf("BtwnEffs_sdV3scld~V3scldtomin.pdf")), height=3.9, width=3.5)
dev.off()
```
## # Is V3 cariance colinear with VD?
```{r}
summary(test <- lmer(sdbid3 ~ VD + (1|subID), data = grpdcsn[grpdcsn$choice != 2,]))
summary(test <- lmer(sdbid3scld ~ VDscld + (1|subID), data = grpdcsn[grpdcsn$choice != 2,]))
plot(sdbid3 ~ VD, data = grpdcsn[grpdcsn$choice != 2,])
summary(test <- lm(sdbid3 ~ VD, data = grpdcsn[grpdcsn$choice != 2,]))
summary(test <- lm(sdbid3scld ~ VDscld, data = grpdcsn[grpdcsn$choice != 2,]))
summary(test <- glm(choice ~ VDscld + TimePressure + V3scld + sdbid3scld + V3scld:sdbid3scld + V3scld:TimePressure + sdbid3scld:TimePressure, family = "binomial", data = grpdcsn[grpdcsn$choice != 2 & grpdcsn$V3scld >= 0 & grpdcsn$V3scld <= 1,]))

# Visualize data
Window <- 0.15
LowestV3 <- 0
HighestV3 <- 1
NtrialThresh <- 120
nlines <- 3
t_values <- c('Low', 'High')
v3vec <- seq(LowestV3+Window, HighestV3-Window, by = .03)
# sdvec <- seq(0, .35, by = .07)
# Create a new figure
par(mfrow = c(1, 2))
ti <- 0
for (t in t_values) {
  ti <- ti + 1
  # Filter data
  dat <- AccID3[AccID3$V3scld <= HighestV3 & AccID3$V3scld >= LowestV3 & AccID3$TimePressure == t,]
  sdvec <- quantile(dat$sdbid3scld, probs = seq(0,1,1/(nlines)))
  # Initialize matrices
  Ntrial <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  VDscld <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  VDscldse <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  sdbid3scld <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  for (vi in seq_along(v3vec)) {
    for (ri in 1:nlines) {
      v3 <- v3vec[vi]
      r <- sdvec[ri]
      maskv3 <- dat$V3scld >= (v3 - Window) & dat$V3scld <= (v3 + Window)
      maskr3 <- dat$sdbid3scld >= sdvec[ri] & dat$sdbid3scld <= sdvec[ri+1]
      section <- dat[maskv3 & maskr3, ]
      Ntrial[ri, vi] <- sum(section$Ntrial)
      if (Ntrial[ri, vi] > NtrialThresh)
      {VDscld[ri, vi] <- mean(section$VDscld)
      VDscldse[ri, vi] <- sd(section$VDscld) / sqrt(length(section$VDscld))
      sdbid3scld[ri, vi] <- mean(section$sdbid3scld)}
    }
  }
  # Plotting
  if (ti == 1){cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(length(sdvec))
  cmap1 <- cmap}
  if (ti == 2){cmap <- colorRampPalette(c("blue", rgb(0, 1, 128/255)))(length(sdvec))
  cmap2 <- cmap}
  cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)
  plot(v3vec, VDscld[1, ], type = "n", ylim = c(.55, 2),  xlab=' ', ylab=' ', 
       axes = FALSE, frame.plot = FALSE, main = sprintf("Time limit %s", t))
  axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
  axis(2, tck = -0.02, at = seq(.6, 2, .2), padj = 1, cex.axis = 1)
  title(ylab = 'Scaled V1 - V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  for (ri in seq_along(sdvec)) {
    thresh <- Ntrial[ri,] > NtrialThresh
    polygon(c(v3vec[thresh], rev(v3vec[thresh])),c(VDscld[ri, thresh]+VDscldse[ri,thresh], rev(VDscld[ri, thresh]-VDscldse[ri,thresh])), border = NA, col = cmaptrnsp[ri])
    lines(v3vec[thresh], VDscld[ri, thresh], type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
  }
}
# legend('topleft', rep(c('0','.07','.14','.21','.28','.35'),2), lty = 1, ncol = 2,  col = c(cmap1, cmap2))
dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Data_VDscld_Qntls_L%.1fH%.1fv2.pdf', LowestV3, HighestV3)), height=4.4, width=7.7)
dev.off()

Window <- 0.15
LowestV3 <- 0
HighestV3 <- 1
v3vec <- seq(LowestV3+Window, HighestV3-Window, .015)
par(mfrow = c(1, 2))
for (v in c('Vague','Precise'))
{
  ti <- 0
  for (tp in c('Low','High'))
  {
    ti <- ti + 1
    if (v == 'Vague' & tp == 'Low'){mycol <- rgb(1, 0, 0)
    mycoltrnsp <- rgb(1, 0, 0, .2)}
    if (v == 'Precise' & tp == 'High'){mycol <- rgb(0, 0, 1)
    mycoltrnsp <- rgb(0,0,1,.2)}
    if (v == 'Precise' & tp == 'Low'){mycol <- rgb(1, 191/255, 0)
    mycoltrnsp <- rgb(1, 191/255, 0, .2)}
    if (v == 'Vague' & tp == 'High'){mycol <- rgb(0, 1, 128/255)
    mycoltrnsp <- rgb(0, 1, 128/255, .2)}
    onesect <- AccID3[AccID3$Vagueness == v & AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
    VDscld <- c()
    VDscldse <- c()
    Ntrial <- c()
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 - Window & onesect$V3scld < v3 + Window
      n <- sum(onesect$Ntrial[mask])
      p <- weighted.mean(onesect$VDscld[mask], onesect$Ntrial[mask])
      Ntrial <- rbind(Ntrial, n)
      VDscld <- rbind(VDscld, p)
      VDscldse <- rbind(VDscldse, sd(section$VDscld) / sqrt(sum(mask)))
    }
    if (ti == 1)
    {plot(v3vec, acc, col = mycol, 
          xlim = c(min(v3vec), max(v3vec)), ylim = c(.8, 1.6), xlab=' ', ylab=' ', 
          type = "n", axes = FALSE, frame.plot = FALSE)
      axis(1, at = c(seq(0, 1, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
      axis(2, tck = -0.02, at = seq(.8, 1.6, .2), padj = 1, cex.axis = 1)
      title(ylab = 'Scaled V1 - V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
      title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    }
    polygon(c(v3vec, rev(v3vec)),c(VDscld+VDscldse, rev(VDscld-VDscldse)), border = NA, col = mycoltrnsp)
    lines(v3vec, VDscld, col = mycol, lwd = 2)
  }
}
dev.copy(pdf, file.path(out_dir,sprintf("VDscld_SldWndwWght_ID3_v3.pdf")), height=4.4, width=7.7)
dev.off()

# generate data
N <- 4312
simdat <- c()
# Loop through each subject
for (subi in 1:N) {
  # Generate random values and sort in descending order
  Vs <- sort(runif(12) * sample(1:90, 1), decreasing = TRUE)
  # Generate combinations of the top 6 values
  Trgts <- combn(Vs[1:6], 2)
  V3s <- Vs[7:12]
  sdbid3s <- sqrt(rchisq(6, 3))/1.6*.1045*V3s
  ID3s <- 7:12
  V3sscld <- V3s/Vs[6]
  Trgtsscld <- Trgts/Vs[6]
  sdbid3sscld <- sdbid3s/Vs[6]
  for (v3i in seq_along(V3s))
  {
    simdat <- rbind(simdat, data.frame(subi = subi, ID3 = ID3s[v3i], V1 = Trgts[1, ], V2 = Trgts[2, ], V3 = V3s[v3i], sdbid3 = sdbid3s[v3i], VD = Trgts[1, ] - Trgts[2, ], V1scld = Trgtsscld[1, ], V2scld = Trgtsscld[2, ], V3scld = V3sscld[v3i], sdbid3scld = sdbid3sscld[v3i], VDscld = Trgtsscld[1, ] - Trgtsscld[2, ]))
  }
}

subID <- unique(simdat$subi)
AccID3sim <- c()
for (s in 1:length(subID))
{
  sectdat <- simdat[simdat$subi == subID[s],]
  V3scld <- aggregate(V3scld ~ ID3, data = sectdat, FUN = mean)
  sdbid3scld <- aggregate(sdbid3scld ~ ID3, data = sectdat, FUN = mean)
  Ntrial <- aggregate(V3scld ~ ID3, data = sectdat, FUN = length)
  colnames(Ntrial) <- c('ID3','Ntrial')
  VDscld <- aggregate(VDscld ~ ID3, data = sectdat, FUN = mean)
  onesect <- merge(V3scld, VDscld, by = 'ID3')
  onesect <- merge(onesect, sdbid3scld, by = 'ID3')
  AccID3sim <- rbind(AccID3sim, data.frame(subID = subID[s], onesect))
}
# Visualize simulation
Window <- 0.15
LowestV3 <- 0
HighestV3 <- 1
v3vec <- seq(LowestV3+Window, HighestV3-Window, by = .03)
nlines <- 3
# sdvec <- seq(0, .26, by = .035)
# Filter data
dat <- AccID3sim[AccID3sim$V3scld <= HighestV3 & AccID3sim$V3scld >= LowestV3,]
sdvec <- quantile(dat$sdbid3scld, probs = seq(0,1,1/(nlines)))
VDscld <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
VDscldse <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
sdbid3scld <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
for (vi in seq_along(v3vec)) {
  for (ri in 1:nlines) {
    v3 <- v3vec[vi]
    r <- sdvec[ri]
    maskv3 <- dat$V3scld >= (v3 - Window) & dat$V3scld <= (v3 + Window)
    maskr3 <- dat$sdbid3scld >= sdvec[ri] & dat$sdbid3scld <= sdvec[ri+1]
    section <- dat[maskv3 & maskr3, ]
    VDscld[ri, vi] <- mean(section$VDscld)
    VDscldse[ri, vi] <- sd(section$VDscld) / sqrt(length(section$VDscld))
    sdbid3scld[ri, vi] <- mean(section$sdbid3scld)
  }
}
# Plotting
cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(length(sdvec))
cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)
plot(v3vec, VDscld[1, ], type = "n", ylim = c(.19, .62),  xlab=' ', ylab=' ', 
     axes = FALSE, frame.plot = FALSE)
axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
axis(2, tck = -0.02, at = seq(.2, .6, .1), padj = 1, cex.axis = 1)
title(ylab = 'Scaled V1 - V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
for (ri in seq_along(sdvec)) {
  polygon(c(v3vec, rev(v3vec)),c(VDscld[ri, ]+VDscldse[ri,], rev(VDscld[ri, ]-VDscldse[ri,])), border = NA, col = cmaptrnsp[ri])
  lines(v3vec, VDscld[ri, ], type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
}
dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Sims_VDscld_Qntls_L%.1fH%.1fv2.pdf', LowestV3, HighestV3)), height=4.4, width=7.7/2)
dev.off()
```




# Bins, weighted, including zero or not
```{r}
Binsz <- .08
LowestV3 <- 0.2
HighestV3 <- .8
par(mfrow = c(1, 2))
for (v in c('Vague','Precise'))
{
  ti <- 0
  for (tp in c('Low','High'))
  {
    ti <- ti + 1
    if (v == 'Vague' & tp == 'Low'){mycol <- rgb(1, 0, 0)
    mycoltrnsp <- rgb(1, 0, 0, .2)}
    if (v == 'Precise' & tp == 'High'){mycol <- rgb(0, 0, 1)
    mycoltrnsp <- rgb(0,0,1,.2)}
    if (v == 'Precise' & tp == 'Low'){mycol <- rgb(0, 1, 128/255)
    mycoltrnsp <- rgb(0, 1, 128/255, .2)}
    if (v == 'Vague' & tp == 'High'){mycol <- rgb(1, 191/255, 0)
    mycoltrnsp <- rgb(1, 191/255, 0, .2)}
    onesect <- AccID3[AccID3$Vagueness == v & AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
    acc <- c()
    sdacc <- c()
    Ntrial <- c()
    v3vec <- seq(LowestV3, HighestV3, Binsz)
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 - Binsz/2 & onesect$V3scld < v3 + Binsz/2
      n <- sum(onesect$Ntrial[mask])
      p <- weighted.mean(onesect$acc[mask], onesect$Ntrial[mask])
      Ntrial <- rbind(Ntrial, n)
      acc <- rbind(acc, p)
      sdacc <- rbind(sdacc, sqrt(p*(100-p)/n))
    }
    if (ti == 1)
    {plot(v3vec, acc, col = mycol, 
          xlim = c(LowestV3, HighestV3), ylim = c(61.8,75), xlab=' ', ylab=' ', 
          type = "n", axes = FALSE, frame.plot = FALSE)
      axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
      axis(2, tck = -0.02, at = seq(62, 74, 3), padj = 1, cex.axis = 1)
      title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
      title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    }
    polygon(c(v3vec, rev(v3vec)),c(acc+sdacc, rev(acc-sdacc)), border = NA, col = mycoltrnsp)
    lines(v3vec, acc, col = mycol, lwd = 2)
    summary(test <- lm(acc ~ v3vec, weights = Ntrial))
    abline(test, col = mycol)
  }
}
dev.copy(pdf, file.path(out_dir,sprintf("Choice~V3scldtomin_Bins_ID3.pdf")), height=4.4, width=7.7)
dev.off()
```
# Sliding windows, weighted, including zero or not
```{r}
Window <- 0.15
LowestV3 <- 0
HighestV3 <- 1
v3vec <- seq(LowestV3+Window, HighestV3-Window, .015)
par(mfrow = c(1, 2))
for (v in c('Vague','Precise'))
{
  ti <- 0
  for (tp in c('Low','High'))
  {
    ti <- ti + 1
    if (v == 'Vague' & tp == 'Low'){mycol <- rgb(1, 0, 0)
    mycoltrnsp <- rgb(1, 0, 0, .2)}
    if (v == 'Precise' & tp == 'High'){mycol <- rgb(0, 0, 1)
    mycoltrnsp <- rgb(0,0,1,.2)}
    if (v == 'Precise' & tp == 'Low'){mycol <- rgb(1, 191/255, 0)
    mycoltrnsp <- rgb(1, 191/255, 0, .2)}
    if (v == 'Vague' & tp == 'High'){mycol <- rgb(0, 1, 128/255)
    mycoltrnsp <- rgb(0, 1, 128/255, .2)}
    onesect <- AccID3[AccID3$Vagueness == v & AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
    acc <- c()
    sdacc <- c()
    Ntrial <- c()
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 - Window & onesect$V3scld < v3 + Window
      n <- sum(onesect$Ntrial[mask])
      p <- weighted.mean(onesect$acc[mask], onesect$Ntrial[mask])
      Ntrial <- rbind(Ntrial, n)
      acc <- rbind(acc, p)
      sdacc <- rbind(sdacc, sqrt(p*(100-p)/n))
    }
    if (ti == 1)
    {plot(v3vec, acc, col = mycol, 
          xlim = c(min(v3vec), max(v3vec)), ylim = c(61.8, 75), xlab=' ', ylab=' ', 
          type = "n", axes = FALSE, frame.plot = FALSE)
      axis(1, at = c(seq(0, 1, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
      axis(2, tck = -0.02, at = seq(62, 74, 3), padj = 1, cex.axis = 1)
      title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
      title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    }
    polygon(c(v3vec, rev(v3vec)),c(acc+sdacc, rev(acc-sdacc)), border = NA, col = mycoltrnsp)
    lines(v3vec, acc, col = mycol, lwd = 2)
    test <- lm(acc ~ v3vec, weights = Ntrial)
    abline(test, col = mycol)
  }
}
dev.copy(pdf, file.path(out_dir,sprintf("Choice~V3scldtomin_SldWndwWght_ID3_v3.pdf")), height=4.4, width=7.7)
dev.off()
```
## Pespective 2: Medium split early noise based on bidding variance but not the vagueness conditions
# Sliding windows, weighted
```{r}
Window <- 0.15
LowestV3 <- 0.2
HighestV3 <- .8
par(mfrow = c(1, 2))
for (v in c('Vague','Precise'))
{
  ti <- 0
  for (tp in c('Low','High'))
  {
    ti <- ti + 1
    if (v == 'Vague' & tp == 'Low'){mycol <- rgb(1, 0, 0)
    mycoltrnsp <- rgb(1, 0, 0, .2)}
    if (v == 'Precise' & tp == 'High'){mycol <- rgb(0, 0, 1)
    mycoltrnsp <- rgb(0,0,1,.2)}
    if (v == 'Vague' & tp == 'High'){mycol <- rgb(0, 1, 128/255)
    mycoltrnsp <- rgb(0, 1, 128/255, .2)}
    if (v == 'Precise' & tp == 'Low'){mycol <- rgb(1, 191/255, 0)
    mycoltrnsp <- rgb(1, 191/255, 0, .2)}
    
    onesect <- AccID3[AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
    
    medval <- median(onesect$sdbid3scld)
    if (v == 'Vague'){maskv <- onesect$sdbid3scld >= medval}
    if (v == 'Precise'){maskv <- onesect$sdbid3scld <= medval}
    onesect <- onesect[maskv,]
    acc <- c()
    sdacc <- c()
    Ntrial <- c()
    v3vec <- seq(LowestV3, HighestV3, .015)
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 - Window & onesect$V3scld < v3 + Window
      n <- sum(onesect$Ntrial[mask])
      p <- weighted.mean(onesect$acc[mask], onesect$Ntrial[mask])
      Ntrial <- rbind(Ntrial, n)
      acc <- rbind(acc, p)
      sdacc <- rbind(sdacc, sqrt(p*(100-p)/n))
    }
    if (ti == 1)
    {plot(v3vec, acc, col = mycol, 
          xlim = c(LowestV3, HighestV3), ylim = c(60,74), xlab=' ', ylab=' ', 
          type = "n", axes = FALSE, frame.plot = FALSE)
      axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
      axis(2, tck = -0.02, at = seq(60, 74, 3), padj = 1, cex.axis = 1)
      title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
      title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    }
    polygon(c(v3vec, rev(v3vec)),c(acc+sdacc, rev(acc-sdacc)), border = NA, col = mycoltrnsp)
    lines(v3vec, acc, col = mycol, lwd = 2)
    test <- lm(acc ~ v3vec, weights = Ntrial)
    abline(test, col = mycol)
  }
}
dev.copy(pdf, file.path(out_dir,sprintf("Choice~MedSpltV3scldtomin_SldWndwWght_ID3v2.pdf")), height=4.4, width=7.7)
dev.off()
```
# Visualize Medium splitted V3 and their variance
```{r}
LowestV3 <- 0
HighestV3 <- 1
par(mfrow = c(1, 1))
i <- 0 
for (v in c('Vague','Precise'))
{
  
  for (tp in c('Low','High')) # decision noise
  {
    i <- i + 1
    if (v == 'Vague' & tp == 'Low'){mycol <- rgb(1, 0, 0)
    mycoltrnsp <- rgb(1, 0, 0, .2)}
    if (v == 'Precise' & tp == 'High'){mycol <- rgb(0, 0, 1)
    mycoltrnsp <- rgb(0,0,1,.2)}
    if (v == 'Vague' & tp == 'High'){mycol <- rgb(0, 1, 128/255)
    mycoltrnsp <- rgb(0, 1, 128/255, .2)}
    if (v == 'Precise' & tp == 'Low'){mycol <- rgb(1, 191/255, 0)
    mycoltrnsp <- rgb(1, 191/255, 0, .2)}
    onesect <- AccID3[AccID3$TimePressure == tp & AccID3$V3scld >= LowestV3 & AccID3$V3scld <= HighestV3,]
    medval <- median(onesect$sdbid3scld)
    if (v == 'Vague'){maskv <- onesect$sdbid3scld >= medval}
    if (v == 'Precise'){maskv <- onesect$sdbid3scld <= medval}
    onesect <- onesect[maskv,]
    v3vec <- seq(LowestV3, HighestV3, .015)
    sd3 <- c()
    Ntrial <- c()
    for (v3 in v3vec)
    {
      mask <- onesect$V3scld > v3 -.15 & onesect$V3scld < v3 + .15
      Ntrial <- rbind(Ntrial, sum(onesect$Ntrial[mask]))
      sd3 <- rbind(sd3, weighted.mean(onesect$sdbid3scld[mask],onesect$Ntrial[mask]))
    }
    if (i == 1){plot(v3vec, sd3, col = mycol, 
                     xlim = c(LowestV3, HighestV3), ylim = c(0,1),  xlab=' ', ylab=' ', 
                     type = "n", axes = FALSE, frame.plot = FALSE)
      axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
      axis(2, tck = -0.02, at = seq(0, 1, .2), padj = 1, cex.axis = 1)
      title(ylab = 'Standard Deviation of Scaled V3', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
      title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    }
    points(onesect$V3scld, onesect$sdbid3scld, col = mycoltrnsp, cex = .8, p = 20)
    lines(v3vec, sd3, col = mycol)
  }
}
dev.copy(pdf, file.path(out_dir,sprintf("V3scldVar~MedSpltV3scldtomin_SldWndwWght_ID3v2.pdf")), height=4.4, width=4.4) #height=4.4, width=7.7/2)
dev.off()
```

## Pespective 3: bin the sdV3scld
```{r}
# Define parameters
Window <- 0.15
Bindow <- .07
LowestV3 <- 0
HighestV3 <- 1
NtrialThresh <- 120
t_values <- c('Low', 'High')
v3vec <- seq(LowestV3, HighestV3, by = .03)
sdvec <- seq(0, .35, by = .07)

# Create a new figure
par(mfrow = c(1, 2))
ti <- 0
for (t in t_values) {
  ti <- ti + 1
  
  # Filter data
  dat <- AccID3[AccID3$V3scld <= HighestV3 & AccID3$V3scld >= LowestV3 & AccID3$TimePressure == t,]
  
  # Initialize matrices
  Ntrial <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  choice <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  choicese <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  sdbid3scld <- matrix(NA, nrow = length(sdvec), ncol = length(v3vec))
  
  for (vi in seq_along(v3vec)) {
    for (ri in seq_along(sdvec)) {
      v3 <- v3vec[vi]
      r <- sdvec[ri]
      
      maskv3 <- dat$V3scld >= (v3 - Window) & dat$V3scld <= (v3 + Window)
      maskr3 <- dat$sdbid3scld >= (r - Bindow) & dat$sdbid3scld <= (r + Bindow)
      section <- dat[maskv3 & maskr3, ]
      Ntrial[ri, vi] <- sum(section$Ntrial)
      if (Ntrial[ri, vi] > NtrialThresh)
        {choice[ri, vi] <- mean(section$acc)
      choicese[ri, vi] <- sd(section$acc) / sqrt(length(section$acc))
      sdbid3scld[ri, vi] <- mean(section$sdbid3scld)}
    }
  }
  
  # Plotting
  if (ti == 1){cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(length(sdvec))
  cmap1 <- cmap}
  if (ti == 2){cmap <- colorRampPalette(c("blue", rgb(0, 1, 128/255)))(length(sdvec))
  cmap2 <- cmap}
  # cmap <- gray(seq(0,.8,length.out = length(sdvec)))
  
  # Plot 1
  plot(v3vec, choice[1, ], type = "n", ylim = c(55, 75),  xlab=' ', ylab=' ', 
       axes = FALSE, frame.plot = FALSE, main = sprintf("Time limit %s", t))
  axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
  axis(2, tck = -0.02, at = seq(55, 75, 5), padj = 1, cex.axis = 1)
  title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  for (ri in seq_along(sdvec)) {
    thresh <- Ntrial[ri,] > NtrialThresh
    lines(v3vec[thresh], choice[ri, thresh], type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
  }
  
  # Plot 2 (Image plot)
  # image(v3vec, varvec, t(choice), col = cmap, xlab = "Scaled V3", ylab = "V3 Variance", 
  #      main = "", zlim = c(45, 75))
  # box()
  # colorbar <- colorRampPalette(c("blue", "green", "yellow", "red"))(100)
}
legend('topleft', rep(c('0','.07','.14','.21','.28','.35'),2), lty = 1, ncol = 2,  col = c(cmap1, cmap2))
dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Data_V3scld_L%.1fH%.1fv2.pdf', LowestV3, HighestV3)), height=4.4, width=7.7)
dev.off()
```

## Pespective 4: Quantiles of the sdV3scld, quantile over the full range of V3scld
```{r}
library(grDevices)
# Define parameters
Window <- .2 #.2 #0.15
LowestV3 <- 0
HighestV3 <- 1
NtrialThresh <- 150
t_values <- c('Low', 'High')
# v3vec <- seq(LowestV3+Window, HighestV3-Window, by = .03)
v3vec <- seq(LowestV3+Window, HighestV3-Window, by = .03)
nlines <- 4
# Create a new figure
par(mfrow = c(1, 2))
ti <- 0
for (t in t_values) {
  ti <- ti + 1
  # Filtering data
  dat <- AccID3[AccID3$V3scld <= HighestV3 & AccID3$V3scld >= LowestV3 & AccID3$TimePressure == t,]
  sdvec <- quantile(dat$sdbid3scld, probs = seq(0,1,1/(nlines)))
  #sdvec <- c(0, .06, .16, .35)
  #sdvec <- seq(0, .35, by = .07)
  # sdvec <- sdvec[-1]
  # Initialize matrices
  Ntrial <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  choice <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  choicese <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  sdbid3scld <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  for (vi in seq_along(v3vec)) {
    v3 <- v3vec[vi]
    maskv3 <- dat$V3scld >= (v3 - Window) & dat$V3scld <= (v3 + Window)
    for (ri in 1:nlines) {
      maskr3 <- dat$sdbid3scld > sdvec[ri] & dat$sdbid3scld < sdvec[ri+1]
      section <- dat[maskv3 & maskr3, ]
      Ntrial[ri, vi] <- sum(section$Ntrial)
      if (Ntrial[ri, vi] > NtrialThresh)
      {choice[ri, vi] <- mean(section$acc)
      choicese[ri, vi] <- sd(section$acc) / sqrt(length(section$acc))
      sdbid3scld[ri, vi] <- mean(section$sdbid3scld)}
    }
  }
  
  # Plotting
  if (ti == 1){cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(nlines)
  cmap1 <- cmap
  cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)}
  if (ti == 2){cmap <- colorRampPalette(c("blue", rgb(0, 1, 128/255)))(nlines)
  cmap2 <- cmap
  cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)}
  # cmap <- gray(seq(0,.8,length.out = length(sdvec)))
  
  # Plot 1
  plot(v3vec, choice[1, ], type = "n", ylim = c(60, 75),  xlab=' ', ylab=' ', 
       axes = FALSE, frame.plot = FALSE, main = sprintf("Time limit %s", t))
  axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
  axis(2, tck = -0.02, at = seq(55, 75, 5), padj = 1, cex.axis = 1)
  title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  for (ri in 1:nlines) {
    thresh <- Ntrial[ri,] > NtrialThresh
    # polygon(c(v3vec[thresh], rev(v3vec[thresh])),c(choice[ri, thresh]+choicese[ri, thresh], rev(choice[ri, thresh]-choicese[ri, thresh])), border = NA, col = cmaptrnsp[ri])
    lines(v3vec[thresh], choice[ri, thresh], type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
  }
}
# legend('topleft', rep(c('0','.07','.14','.21','.28','.35'),2), lty = 1, ncol = 2,  col = c(cmap1, cmap2))
dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Data_V3scld_sdQntls_L%.1fH%.1f_111.pdf', LowestV3, HighestV3)), height=4.4, width=7.7)
dev.off()
```

## Pespective 4: Quantiles of the sdV3scld, quantile within each bin of V3scld
```{r}
library(grDevices)
# Define parameters
Window <- .2 #0.15
LowestV3 <- 0
HighestV3 <- 1
NtrialThresh <- 120
t_values <- c('Low', 'High')
v3vec <- seq(LowestV3+Window, HighestV3-Window, by = .03)

# Create a new figure
par(mfrow = c(1, 2))
ti <- 0
for (t in t_values) {
  ti <- ti + 1
  # Initialize matrices
  nlines <- 3
  Ntrial <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  choice <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  choicese <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  sdbid3scld <- matrix(NA, nrow = nlines, ncol = length(v3vec))
  # Filter data
  dat <- AccID3[AccID3$V3scld <= HighestV3 & AccID3$V3scld >= LowestV3 & AccID3$TimePressure == t,]
  for (vi in seq_along(v3vec)) {
    v3 <- v3vec[vi]
    maskv3 <- dat$V3scld >= (v3 - Window) & dat$V3scld <= (v3 + Window)
    slide <- dat[maskv3, ]
    sdvec <- quantile(slide$sdbid3scld, probs = seq(0,1,1/(nlines+1)))
    for (ri in 1:nlines) {
      section <- slide[slide$sdbid3scld >= sdvec[ri] & slide$sdbid3scld <= sdvec[ri+1], ]
      Ntrial[ri, vi] <- sum(section$Ntrial)
      if (Ntrial[ri, vi] > NtrialThresh)
      {choice[ri, vi] <- mean(section$acc)
      choicese[ri, vi] <- sd(section$acc) / sqrt(length(section$acc))
      sdbid3scld[ri, vi] <- mean(section$sdbid3scld)}
    }
  }
  
  # Plotting
  if (ti == 1){cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(nlines)
  cmap1 <- cmap
  cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)}
  if (ti == 2){cmap <- colorRampPalette(c("blue", rgb(0, 1, 128/255)))(nlines)
  cmap2 <- cmap
  cmaptrnsp <- adjustcolor(cmap, alpha.f = 0.2)}
  # cmap <- gray(seq(0,.8,length.out = length(sdvec)))
  
  # Plot 1
  plot(v3vec, choice[1, ], type = "n", ylim = c(55, 75),  xlab=' ', ylab=' ', 
       axes = FALSE, frame.plot = FALSE, main = sprintf("Time limit %s", t))
  axis(1, at = c(seq(LowestV3, HighestV3, .2)),  tck = -0.02, padj = -1, cex.axis = 1)
  axis(2, tck = -0.02, at = seq(55, 75, 5), padj = 1, cex.axis = 1)
  title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  title(xlab = "Scaled V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
  for (ri in 1:nlines) {
    thresh <- Ntrial[ri,] > NtrialThresh
    polygon(c(v3vec[thresh], rev(v3vec[thresh])),c(choice[ri, thresh]+choicese[ri, thresh], rev(choice[ri, thresh]-choicese[ri, thresh])), border = NA, col = cmaptrnsp[ri])
    lines(v3vec[thresh], choice[ri, thresh], type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
  }
}
# legend('topleft', rep(c('0','.07','.14','.21','.28','.35'),2), lty = 1, ncol = 2,  col = c(cmap1, cmap2))
dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Data_V3scld_sdQntlsWithinV3Bins_L%.1fH%.1f.pdf', LowestV3, HighestV3)), height=4.4, width=7.7)
dev.off()
```

# Visualize model simulations
```{r}
smdir <- '/Users/bs3667/NYU Langone Health Dropbox/Shen Bo/Bo Shen Working files/NoiseProject/Prediction/Fig4'
V1mean <- 88
V2mean <- 83
for (modeli in 1:4)
{
  prdct <- read.table(file = file.path(smdir, sprintf('Ratio_Model%i_50v3max83_6lines.txt', modeli)), header = TRUE)
  v3vec <- unique(prdct$V3) # seq(0, V2mean, length.out = 50)
  early <- unique(prdct$Early) #seq(0, .35, length.out = 6)*V2mean
  late <- unique(prdct$Late) #c(1, 1.4286)
  if (modeli == 1){yrng <- c(75, 95)
  yticks <- seq(75,95,5)}
  if (modeli == 2){yrng <- c(70, 77)
  yticks <- seq(71,77,2)}
  if (modeli == 3){yrng <- c(75, 95)
  yticks <- seq(75,95,5)}
  if (modeli == 4){yrng <- c(60, 75)
  yticks <- seq(60,75,5)}
  if (modeli == 4){par(mfrow = c(1, 2))}
  for (ti in seq_along(late))
  {
    # Plotting
    if (ti == 1){cmap <- colorRampPalette(c(rgb(1, 191/255, 0), "red"))(length(early))
    cmap1 <- cmap}
    if (ti == 2){cmap <- colorRampPalette(c("blue", rgb(0, 1, 128/255)))(length(early))
    cmap2 <- cmap}
    choice <- prdct[prdct$Late == late[ti] & prdct$Early == early[1],]$choice
    if ((ti == 1) || modeli == 4)
    {plot(v3vec, choice, type = "n", xlim = c(0, V1mean), ylim = yrng,  xlab=' ', ylab=' ', 
         axes = FALSE, frame.plot = FALSE, main = sprintf("Late noise %1.2f", late[ti]))
    axis(1, at = c(seq(0, V1mean, 20)),  tck = -0.02, padj = -1, cex.axis = 1)
    axis(2, tck = -0.02, at = yticks, padj = 1, cex.axis = 1)
    title(ylab = '% Correct | V1, V2', mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)
    title(xlab = "V3", mgp = c(1.5,0,0), font.lab = 1, cex.lab = 1)}
    for (ri in seq_along(early)) {
      choice <- prdct[prdct$Late == late[ti] & prdct$Early == early[ri],]$choice
      lines(v3vec, choice, type = "l", col = cmap[ri], pch = 20, cex = .5, lwd = 2)
    }
    points(c(V1mean, V2mean), c(yrng[1], yrng[1]), pch = 25, col = NA, bg = gray(.5), cex = .8)
  }
  if (modeli == 4)
  {legend('topleft', rep(c('0','.07','.14','.21','.28','.35'),2), lty = 1, ncol = 2,  col = c(cmap1, cmap2))
    dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Model%i_v2.pdf', modeli)), height=3.53, width=6.18)}
  if (modeli < 4){dev.copy(pdf, file.path(out_dir,sprintf('CardinalView_Model%i_v2.pdf', modeli)), height=3.53, width=6.18/2)}
  dev.off()
}
```


# Diagram used in Figure 3d
```{r}
subjlist <- unique(grpbid$subID)
indvdat <- grpbid[grpbid$subID == subjlist[2],]
mbid <- aggregate(bid ~ item + touched, data = indvdat, FUN = mean)
mask <- mbid$touched == 1
plot(mbid$bid[mask], mbid$bid[mask]*0, pch = 20, cex = 1, col = 'blue', xlab = "", ylab = "", xaxt = "n", yaxt = "n")
#axis(1, at = seq(0,80,20), tck = -0.03, padj = -1.118, cex.axis = 1)
axis(2, tck = -0.03, at = seq(0,80,20), padj = 1.118, cex.axis = 1)
title(xlab = 'Bid mean ($)', ylab = ' ', mgp = c(1.38,0,0), font.lab = 1, cex.lab = 1)
undat <- mbid[mbid$touched == 0,]
mask <- rank(undat$bid)<13
points(undat$bid[mask], undat$bid[mask]*0, pch = 20, cex = 1, col = 'red')
legend('topleft', c('Ambiguous','Definitive'), pch = 20, col = c('red','blue'), text.col = c('red','blue'), bty = 'n')
dev.copy(pdf,file.path(out_dir,sprintf("Diagram.pdf")),height=3.4, width=3.4)
dev.off()
```

## Model fitting results - Non-negative & dummyTime
```{r}
Analysis <- '/Users/bs3667/NYU Langone Health Dropbox/Shen Bo/Bo Shen Working files/NoiseProject/Modelfit/'
out_dir <- file.path(Analysis,'plot')
if (!dir.exists(out_dir)){dir.create(out_dir)}
fastbads <- read.table(file.path(Analysis,'BestRslts.txt'), header = TRUE, sep = '\t')
demograph <- read.csv('/Users/bs3667/Noise/myData/Demographics.csv', header = TRUE)
fastbads$subID <- as.factor(fastbads$subID)
sublist <- unique(fastbads$subID)
fastbads$name <- factor(fastbads$name, levels = c('McFadden','LinearDistrb','DN','dDNb','dDNd'))
names <- levels(fastbads$name)
fastbads$modeli <- as.factor(fastbads$modeli)
fastbads <- merge(fastbads, demograph, by = 'subID')
str(fastbads)
# convert AIC and BIC
ICpool <- c()
for (si in 1:length(sublist))
{
  N <- sum(grpdcsn$subID == subID[si] & !is.na(grpdcsn$choice)) # number of data points
  for (mdli in 1:5) # number of parameters
  {
    if (mdli == 1){k <- 2}
    if (mdli == 2 | mdli == 3){k <- 3}
    if (mdli >= 4){k <- 4}
    nLL <- fastbads$nll[fastbads$subID == sublist[si] & fastbads$modeli == mdli]
    AIC <- 2*k + 2*nLL
    BIC <- k*log(N) + 2*nLL
    ICpool <- rbind(ICpool, data.frame(subID = sublist[si], modeli = mdli, AIC = AIC, BIC = BIC))
  }
}
fastbads <- merge(fastbads, ICpool, by = c('subID','modeli'))
# list log likelihood
nlls <- aggregate(nll ~ modeli, data = fastbads, FUN = sum)
show(nlls)
# Model comparison
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.BIC.pdf")),height=5, width=5)
dev.off()

par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.BIC.pdf")),height=5, width=5)
dev.off()

par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.AIC.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.BIC.pdf")),height=2.5, width=5)
dev.off()
# Model comparison
par(mfrow=c(2,2))
mdlA <- c(1,1,2,3)
mdlB <- c(2,3,5,5)
for (i in 1:4)
{
  bars <- fastbads$nll[fastbads$modeli == mdlB[i]] - fastbads$nll[fastbads$modeli == mdlA[i]]
  plot(fastbads$nll[fastbads$modeli == mdlA[i]], fastbads$nll[fastbads$modeli == mdlB[i]], pch = 20, xlab = names[mdlA[i]], ylab = names[mdlB[i]])
  abline(a = 0, b = 1, lty = 2)
  legend("topleft",
         legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
         bty = "n")
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Models.pdf")),height=5, width=5)
dev.off()
# distribution of wp
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  bars <- fastbads$wp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'wp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean wp = \n%.3f  %.3f', mean(bars), sd(bars)/sqrt(length(bars))), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("wp.pdf")),height=5, width=5)
dev.off()

# Distribution of Mp
par(mfrow=c(2,3))
for (mdli in 1:5)
{
  bars <- fastbads$Mp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'Mp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean Mp =\n %1.1f  %1.1f', mean(bars), sd(bars)/sqrt(length(bars))), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp.pdf")),height=5, width=7.5)
dev.off()
# Distribution of delta
par(mfrow=c(2,3))
for (mdli in 1:5)
{
  bars <- fastbads$delta[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = expression(delta), main = names[mdli], bty = "n")
  lines(density(bars))
  test <- t.test(bars)
  legend('right',as.expression(bquote(mean~delta == .(sprintf('%1.3f  %1.3f\np = %1.3f', mean(bars), sd(bars)/sqrt(length(bars)), test$p.value)))), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("delta.pdf")),height=5, width=7.5)
dev.off()

# Mp & wp colinearity
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  plot(Mp ~ wp, data = fastbads[fastbads$modeli == mdli,], log ='y', xlab = 'wp',ylab = 'Mp', main = names[mdli], pch = 20)
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp~wp.pdf")),height=5, width=5)
dev.off()
# scaling parameter
par(mfrow=c(2,2))
for (mdli in c(2,4,5))
{
  bars <- fastbads$scl[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = "Scale", main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft', sprintf('scl = %1.2f  %1.2f', mean(bars), sd(bars)/sqrt(length(bars))), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("scl.pdf")),height=5, width=5)
dev.off()
# BIC and scaling correlation
dBIC <- fastbads$BIC[fastbads$modeli == 4] - fastbads$BIC[fastbads$modeli == 3]
scale <- fastbads$scl[fastbads$modeli == 4]
plot(scale, dBIC, pch = 20, cex = .5, xlab = "Scale in dDNb", ylab = as.expression(bquote(Delta~"BIC (dDNb - DN)")))
dev.copy(pdf,file.path(out_dir,sprintf("scl~dBIC.pdf")),height=4, width=4)
dev.off()
# Correlation of age and decision noise
# Early noise impact
tmp <- merge(mrgdat, demograph, by = 'subID')
summary(Rgtest <- lmer(varbid ~ meanbid * age * touched + (1|subID), data = tmp))
summary(test <- lm(varbid ~ meanbid * age * touched, data = tmp))
summary(test <- lm(varbid ~ meanbid * age, data = tmp[tmp$touched == 0,]))
slope <- c()
for (si in unique(mrgdat$subID))
{
  test <- lm(varbid ~ meanbid, data = mrgdat[mrgdat$subID == si & mrgdat$touched == 0,])
  slope <- rbind(slope, data.frame(subID = si, slope = test$coefficients[2]))
}
tmp2 <- merge(slope, demograph, by = 'subID')

plot(slope ~ age, data = tmp2, pch = 20, ylim = c(0,20), xlab = 'Age', ylab = 'Slope of Early-Noise Impact')
summary(test <- lm(slope ~ age, data = tmp2[tmp2$slope<= 20,]))
abline(test, col = 2)
dev.copy(pdf,"/Users/bs3667/NYU Langone Health Dropbox/Shen Bo/Bo Shen Working files/Application - Job/Figures/AgeEarlyNoise.pdf", height=4, width=4)
dev.off()
# Late noise impact
summary(test <- lm(delta ~ age, data = fastbads[fastbads$modeli == 4,]))
plot(delta ~ age, data = fastbads[fastbads$modeli == 4,], pch = 20, xlab = 'Age', ylab = 'Late-Noise Impact due to Time Pressure')
abline(test, col = 2)
dev.copy(pdf,"/Users/bs3667/NYU Langone Health Dropbox/Shen Bo/Bo Shen Working files/Application - Job/Figures/AgeLateNoise.pdf", height=4, width=4)
dev.off()
```
## Model fitting results, Louie et al., 2011
```{r}
Analysis <- '/Users/bs3667/Noise/UnusedCodeorForFutureAnalyses/ReAnalyzeLouie2013/Results/ModelFit_Nested'
out_dir <- file.path(Analysis,'plot')
if (!dir.exists(out_dir)){dir.create(out_dir)}
mt <- read.csv('/Users/bs3667/Noise/UnusedCodeorForFutureAnalyses/ReAnalyzeLouie2013/TrnsfrmData.csv', header = TRUE)
subOrder <- unique(mt$subID)
fastbads <- read.table(file.path(Analysis,'BestRslts.txt'), header = TRUE, sep = '\t')
fastbads$subID <- as.factor(fastbads$subID)
fastbads$name <- factor(fastbads$name, levels = c('McFadden','LinearDistrb','DN','dDNb','dDNd'))
names <- levels(fastbads$name)
fastbads$modeli <- as.factor(fastbads$modeli)
str(fastbads)
# convert AIC and BIC
ICpool <- c()
for (si in subOrder)
{
  N <- sum(mt$subID == si & !is.na(mt$chosenItem)) # number of data points
  for (mdli in 1:5) # number of parameters
  {
    if (mdli == 1){k <- 1}
    if (mdli == 2 | mdli == 3){k <- 2}
    if (mdli >= 4){k <- 3}
    nLL <- fastbads$nll[fastbads$subID == si & fastbads$modeli == mdli]
    AIC <- 2*k + 2*nLL
    BIC <- k*log(N) + 2*nLL
    ICpool <- rbind(ICpool, data.frame(subID = subOrder[si], modeli = mdli, AIC = AIC, BIC = BIC))
  }
}
fastbads <- merge(fastbads, ICpool, by = c('subID','modeli'))
# Model comparison
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.BIC.pdf")),height=5, width=5)
dev.off()

par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.BIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.AIC.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.BIC.pdf")),height=2.5, width=5)
dev.off()
# Model comparison
par(mfrow=c(2,2))
mdlA <- c(1,1,2,3)
mdlB <- c(2,3,5,5)
for (i in 1:4)
{
  bars <- fastbads$nll[fastbads$modeli == mdlB[i]] - fastbads$nll[fastbads$modeli == mdlA[i]]
  plot(fastbads$nll[fastbads$modeli == mdlA[i]], fastbads$nll[fastbads$modeli == mdlB[i]], pch = 20, xlab = names[mdlA[i]], ylab = names[mdlB[i]])
  abline(a = 0, b = 1, lty = 2)
  legend("topleft",
         legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
         bty = "n")
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Models.pdf")),height=5, width=5)
dev.off()
# distribution of wp
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  bars <- fastbads$wp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'wp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean wp = %.3f', mean(bars)), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("wp.pdf")),height=5, width=5)
dev.off()

# Distribution of Mp
par(mfrow=c(2,3))
for (mdli in 1:5)
{
  bars <- fastbads$Mp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'Mp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean Mp = %1.1f', mean(bars)), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp.pdf")),height=5, width=7.5)
dev.off()

# Mp & wp colinearity
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  plot(Mp ~ wp, data = fastbads[fastbads$modeli == mdli,], log ='y', xlab = 'wp',ylab = 'Mp', main = names[mdli], pch = 20)
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp~wp.pdf")),height=5, width=5)
dev.off()
```
## Model fitting results, Gluth et al., 2020
```{r}
Analysis <- '/Users/bs3667/Noise/UnusedCodeorForFutureAnalyses/ReAnalyszeGluth2020/Results/ModelFit_Nested'
out_dir <- file.path(Analysis,'plot')
if (!dir.exists(out_dir)){dir.create(out_dir)}
mt <- read.csv('/Users/bs3667/Noise/UnusedCodeorForFutureAnalyses/ReAnalyszeGluth2020/TrnsfrmData.csv', header = TRUE)
subIDs <- sort(unique(mt$subID))
fastbads <- read.table(file.path(Analysis,'BestRslts.txt'), header = TRUE, sep = '\t')
# fastbads <- fastbads[fastbads$subID < 24,]
fastbads$subID <- as.factor(fastbads$subID)
fastbads$name <- factor(fastbads$name, levels = c('McFadden','LinearDistrb','DN','dDNb','dDNd'))
names <- levels(fastbads$name)
fastbads$modeli <- as.factor(fastbads$modeli)
str(fastbads)
# convert AIC and BIC
ICpool <- c()
for (si in 1:length(subIDs))
{
  N <- sum(mt$subID == subIDs[si] & !is.na(mt$chosenItem)) # number of data points
  for (mdli in 1:5) # number of parameters
  {
    if (mdli == 1){k <- 1}
    if (mdli == 2 | mdli == 3){k <- 2}
    if (mdli >= 4){k <- 3}
    nLL <- fastbads$nll[fastbads$subID == si & fastbads$modeli == mdli]
    AIC <- 2*k + 2*nLL
    BIC <- k*log(N) + 2*nLL
    ICpool <- rbind(ICpool, data.frame(subID = si, modeli = mdli, AIC = AIC, BIC = BIC))
  }
}
fastbads <- merge(fastbads, ICpool, by = c('subID','modeli'))
# Model comparison
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 1)
{
  for (mdlj in 2:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_McFadden.BIC.pdf")),height=5, width=5)
dev.off()

par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'AIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.AIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(2,2))
for (mdli in 2)
{
  for (mdlj in 3:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Mdl2.BIC.pdf")),height=5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$nll[fastbads$modeli == mdlj] - fastbads$nll[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$AIC[fastbads$modeli == mdlj] - fastbads$AIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'nLL', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~AIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.AIC.pdf")),height=2.5, width=5)
dev.off()
par(mfrow=c(1,2))
for (mdli in 3)
{
  for (mdlj in 4:5)
  {
    bars <- fastbads$BIC[fastbads$modeli == mdlj] - fastbads$BIC[fastbads$modeli == mdli]
    hist(bars, xlab = 'BIC', main = sprintf('%s - %s', names[mdlj], names[mdli]), 40)
    legend("topleft",
       legend = as.expression(bquote(italic(Delta~BIC) == .(sprintf("%1.2f", sum(bars))))),
       bty = "n")
  }
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_DN.BIC.pdf")),height=2.5, width=5)
dev.off()
# Model comparison
par(mfrow=c(2,2))
mdlA <- c(1,1,2,3)
mdlB <- c(2,3,5,5)
for (i in 1:4)
{
  bars <- fastbads$nll[fastbads$modeli == mdlB[i]] - fastbads$nll[fastbads$modeli == mdlA[i]]
  plot(fastbads$nll[fastbads$modeli == mdlA[i]], fastbads$nll[fastbads$modeli == mdlB[i]], pch = 20, xlab = names[mdlA[i]], ylab = names[mdlB[i]])
  abline(a = 0, b = 1, lty = 2)
  legend("topleft",
         legend = as.expression(bquote(italic(Delta~nLL) == .(sprintf("%1.2f", sum(bars))))),
         bty = "n")
}
dev.copy(pdf,file.path(out_dir,sprintf("Models_vs_Models.pdf")),height=5, width=5)
dev.off()
# distribution of wp
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  bars <- fastbads$wp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'wp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean wp = %.3f', mean(bars)), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("wp.pdf")),height=5, width=5)
dev.off()

# Distribution of Mp
par(mfrow=c(2,3))
for (mdli in 1:5)
{
  bars <- fastbads$Mp[fastbads$modeli == mdli]
  hist(bars, 40, probability = TRUE, xlab = 'Mp', main = names[mdli], bty = "n")
  lines(density(bars))
  legend('topleft',sprintf('mean Mp = %1.1f', mean(bars)), bty = 'n')
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp.pdf")),height=5, width=7.5)
dev.off()

# Mp & wp colinearity
par(mfrow=c(2,2))
for (mdli in 3:5)
{
  plot(Mp ~ wp, data = fastbads[fastbads$modeli == mdli,], log ='y', xlab = 'wp',ylab = 'Mp', main = names[mdli], pch = 20)
}
dev.copy(pdf,file.path(out_dir,sprintf("Mp~wp.pdf")),height=5, width=5)
dev.off()
```


